<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>GxMods Key Panel</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    :root{
      --bg:#0b0f14;--card:#0f1622;--line:#1a2331;--muted:#9fb1c3;
      --text:#e6edf3;--pri:#7c3aed;--ok:#19c37d;--warn:#f59e0b;
      --r:16px; --shadow:0 6px 24px rgba(0,0,0,.28);
      --bn-h:60px;
    }
    /* Light mode vars (aktif saat body.light) */
    body.light{
      --bg:#f6f7fb;--card:#ffffff;--line:#e6e9ef;--muted:#526375;
      --text:#101318;--pri:#6d28d9;--ok:#16a34a;--warn:#d97706;
    }

    body{
      margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent;
      touch-action:manipulation;user-select:none;-webkit-user-select:none;-webkit-touch-callout:none
    }
    body.allow-select{user-select:text;-webkit-user-select:text;-webkit-touch-callout:auto}
    a{color:inherit;text-decoration:none}
    img,svg{display:block;max-width:100%}
    .hide{display:none !important}
    input,textarea{user-select:text;-webkit-user-select:text}
    .help{display:inline-flex;align-items:center;justify-content:center;width:18px;height:18px;border:1px solid var(--line);border-radius:999px;font-size:.75rem;color:var(--muted);cursor:help;margin-left:6px}

    /* Inputs */
    body,button,input,select,textarea{color:var(--text)}
    .btn{color:var(--text)}
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]),
    select,textarea{
      width:100%;padding:14px;border-radius:12px;background:color-mix(in oklab, var(--card), black 12%);border:1px solid var(--line);outline:none;
      appearance:none;-webkit-appearance:none;-moz-appearance:none;font-size:16px
    }
    body.light input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]),
    body.light select, body.light textarea{
      background:#fff;border-color:#dbe1ea
    }
    input::placeholder,textarea::placeholder{color:#9aa7b3}
    body.light input::placeholder, body.light textarea::placeholder{color:#7b8a98}
    input:-webkit-autofill{-webkit-text-fill-color:var(--text);box-shadow:0 0 0 1000px color-mix(in oklab, var(--card), black 12%) inset;border:1px solid var(--line);caret-color:var(--text)}

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:60;height:56px;display:flex;align-items:center;gap:12px;padding:0 14px;background:color-mix(in oklab, var(--card), black 4%);border-bottom:1px solid var(--line)}
    .title{font-weight:700}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:var(--card);box-shadow:var(--shadow);cursor:pointer;transition:transform .08s ease}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .icon{width:20px;height:20px}

    /* Sync badge */
    .sync{display:inline-flex;align-items:center;gap:8px;font-size:.85rem;color:var(--muted)}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.on{background:#16a34a}
    .dot.off{background:#ef4444}

    /* Drawer */
    .drawer{position:fixed;inset:0 auto 0 0;width:min(78%,320px);background:var(--card);border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .16s ease-out;z-index:70;contain:paint}
    .drawer.open{transform:translateX(0)}
    .drawer .brand{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--line)}
    .nav{padding:8px}
    .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1px solid transparent}
    .nav a:hover{background:color-mix(in oklab, var(--card), black 8%)}
    .nav a.active{border-color:#213048;background:color-mix(in oklab, var(--card), black 8%)}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .16s ease;z-index:65}
    .backdrop.show{opacity:1;pointer-events:auto}

    /* App */
    .app{min-height:calc(100dvh - 56px);padding:14px 14px calc(14px + var(--bn-h) + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:14px}
    body.noauth .app{padding-bottom:14px}
    .page{display:none}
    .page.show{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:12px}
    .muted{color:var(--muted);font-size:.95rem}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    /* Key list */
    .list{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .item{padding:12px;background:color-mix(in oklab, var(--card), black 2%);border-bottom:1px solid var(--line)}
    .item:nth-child(2n){background:color-mix(in oklab, var(--card), black 6%)}
    .item:last-child{border-bottom:none}
    .row1{display:flex;align-items:center;gap:10px}
    .row1 .grow{flex:1;min-width:0}
    .row1 strong{word-break:break-all}
    .row2{margin-top:4px}
    .row3{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    @media (max-width:720px){ .row3{justify-content:flex-start} }

    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:.8rem;white-space:nowrap}
    .ok{background:#10221a;border-color:#1f4e39;color:#9de7c4}
    .soon{background:#2b220c;border-color:#5a4310;color:#ffe5a3}
    .exp{background:#2a1414;border-color:#5d2a2a;color:#ffc8c8}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:var(--card);cursor:pointer;user-select:none}
    .chip.active{outline:2px solid #213048}

    .switch{display:inline-flex;align-items:center;gap:10px}
    .switch input{position:absolute;opacity:0;width:0;height:0}
    .switch .track{width:44px;height:26px;background:#1f2937;border:1px solid var(--line);border-radius:999px;position:relative;transition:background .15s,border-color .15s}
    .switch .thumb{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#cbd5e1;transition:left .15s,background .15s}
    .switch input:checked + .track{background:#12211a;border-color:#1f4e39}
    .switch input:checked + .track .thumb{left:20px;background:#9de7c4}
    body.light .switch .track{background:#e7ecf4;border-color:#dbe1ea}
    body.light .switch input:checked + .track{background:#dcfce7;border-color:#a7f3d0}
    body.light .switch input:checked + .track .thumb{background:#059669}

    /* Guards */
    body.noauth .guarded{display:none !important}
    body.authed .login-only{display:none !important}
    body.noauth #menuBtn,body.noauth #btnSignOut{display:none !important}
    body.noauth .topbar,body.noauth #drawer,body.noauth #backdrop,body.noauth #bottomnav{display:none !important}

    /* Boot splash */
    body.booting .page{display:none !important}
    #boot{position:fixed;inset:0;display:grid;place-items:center;background:var(--bg);z-index:100;font-size:14px;color:var(--muted)}

    .lite .btn,.lite .card{box-shadow:none}
    .reduce *{transition:none!important;animation:none!important}

    /* Login center */
    [data-page="login"].show{min-height:calc(100dvh - 56px);place-content:center}

    /* Toast center */
    #toast{position:fixed;left:50%;top:50%;transform:translate(-50%,-50%);background:color-mix(in oklab, var(--card), black 6%);border:1px solid var(--line);padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);display:none;z-index:99;pointer-events:none;text-align:center;max-width:min(92vw,520px)}

    .dense .item{padding:8px}
    .dense .pill{font-size:.74rem;padding:2px 6px}
    .dense .btn.small{padding:6px 8px}

    /* Bottom Nav */
    .bottomnav{position:fixed;left:0;right:0;bottom:0;height:var(--bn-h);background:color-mix(in oklab, var(--card), black 4%);border-top:1px solid var(--line);display:grid;grid-template-columns:repeat(2,1fr);z-index:55;padding-bottom:env(safe-area-inset-bottom)}
    .bottomnav a{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:4px;font-size:.85rem;color:var(--muted)}
    .bottomnav a .bi{width:22px;height:22px}
    .bottomnav a.active{color:var(--text)}

    /* Modal base */
    .modal{position:fixed;inset:0;background:rgba(0,0,0,.5);display:none;align-items:center;justify-content:center;z-index:90}
    .modal.show{display:flex}
    .modal-card{width:min(92vw,420px);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;gap:10px}
    .modal-actions{display:flex;gap:10px;justify-content:flex-end}

    /* Mini progress bar */
    .bar{height:10px;border-radius:999px;background:color-mix(in oklab, var(--card), black 8%);overflow:hidden;border:1px solid var(--line)}
    .bar > i{display:block;height:100%;background:linear-gradient(90deg,#16a34a,#22c55e)}
  </style>
</head>
<body class="noauth booting">
  <!-- Topbar -->
  <header class="topbar">
    <button id="menuBtn" class="btn" aria-label="Menu" aria-haspopup="true" aria-controls="drawer" aria-expanded="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span>Menu</span>
    </button>
    <div class="title">GxMods Key Panel</div>
    <div class="grow"></div>
    <div class="sync" id="syncInfo" title="Status sinkronisasi">
      <span class="dot off" id="dot"></span><span id="syncText">Offline</span>
    </div>
    <button id="btnSignOut" class="btn ghost">Sign Out</button>
  </header>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true" tabindex="-1">
    <div class="brand"><strong>Menu</strong></div>
    <nav class="nav" id="nav">
      <a href="#audit" data-route="audit" data-auth="in">Audit</a>
      <a href="#settings" data-route="settings" data-auth="in">Pengaturan</a>
      <a href="#about" data-route="about">Tentang</a>
    </nav>
  </aside>
  <div id="backdrop" class="backdrop"></div>

  <!-- App -->
  <main id="app" class="app">
    <!-- Dashboard / Home -->
    <section class="page guarded" data-page="dashboard">
      <div class="grid">
        <div class="card">
          <h3>Status</h3>
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <span class="muted">Key aktif</span><strong id="kpiKeys">0</strong>
          </div>
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <span class="muted">Key expired</span><strong id="kpiExp">0</strong>
          </div>
          <div class="row" style="display:flex;gap:10px;align-items:center">
            <div class="muted" style="min-width:120px">Aktif vs Expired</div>
            <div class="bar" style="flex:1"><i id="barFill" style="width:0%"></i></div>
            <div class="muted" id="barLabel">0%</div>
          </div>
          <div class="row muted" id="weekStats">Statistik mingguan: -</div>
        </div>
      </div>
    </section>

    <!-- Keys -->
    <section class="page guarded" data-page="keys">
      <!-- Global Key (opsional) -->
      <div class="card" id="globalKeyCard">
        <h3>Global Key</h3>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="globalKey" type="text" placeholder="Kosongkan jika tidak pakai"/>
          <button id="btnSaveGlobal" class="btn small">Simpan</button>
          <button id="btnClearGlobal" class="btn small">Hapus</button>
        </div>
      </div>

      <!-- Buat Key (tetap tampil) -->
      <div class="card" id="createKeyCard">
        <h3 style="text-align:center">Buat Key</h3>
        <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newKey" type="text" placeholder="Key baru" style="flex:1;min-width:180px"/>
        </div>
        <div class="row" style="display:flex;justify-content:center">
          <button id="btnGen" class="btn small">Generate</button>
        </div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <label class="muted" for="exp" style="min-width:160px">Tanggal kadaluarsa (opsional)</label>
          <input id="exp" type="date" inputmode="none" placeholder="dd-mm-yyyy" style="max-width:220px"/>
          <span class="chip" data-add="7">+7 hari</span>
          <span class="chip" data-add="0">Tanpa Exp</span>
          <div style="flex:1"></div>
          <button id="btnAdd" class="btn small">Tambah</button>
        </div>
      </div>

      <!-- Daftar Key -->
      <div class="card">
        <div class="row" style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:space-between">
          <h3 style="margin:0">Daftar Key</h3>
          <input id="search" type="search" placeholder="Cari key…" style="min-width:160px;max-width:260px" autocomplete="off">
        </div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <span class="chip filter" data-filter="all">Semua</span>
          <span class="chip filter" data-filter="active">Aktif</span>
          <span class="chip filter" data-filter="soon">Segera Habis</span>
          <span class="chip filter" data-filter="expired">Expired</span>
          <span class="chip filter" data-filter="permanent">Tanpa Exp</span>
        </div>
        <div id="keyList" class="list" role="list"></div>
      </div>
    </section>

    <!-- Settings -->
    <section class="page guarded" data-page="settings">
      <div class="card">
        <h3>Pengaturan</h3>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Padatkan daftar key</strong><span class="help" title="Tinggi item & tombol diperkecil.">?</span></div>
          <label class="switch"><input id="dense" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Kurangi animasi</strong><span class="help" title="Matikan transisi & bayangan.">?</span></div>
          <label class="switch"><input id="reduce" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Urutkan expired dulu</strong><span class="help" title="Item kadaluarsa tampil di atas.">?</span></div>
          <label class="switch"><input id="sortExpired" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Sembunyikan Global Key</strong><span class="help" title="Hanya kartu 'Global Key' yang disembunyikan.">?</span></div>
          <label class="switch"><input id="hideGlobal" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Izinkan seleksi teks</strong><span class="help" title="Matikan anti-salin jika perlu copy manual.">?</span></div>
          <label class="switch"><input id="allowSelect" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div><strong>Tema terang (Light Mode)</strong><span class="help" title="Ganti ke tampilan terang.">?</span></div>
          <label class="switch"><input id="lightMode" type="checkbox"><span class="track"><i class="thumb"></i></span></label>
        </div>
      </div>
    </section>

    <!-- Audit -->
    <section class="page guarded" data-page="audit">
      <div class="card">
        <h3>Audit Ringan</h3>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <input id="auditSearch" type="search" placeholder="Cari di audit (key / aksi / uid)..." style="max-width:280px">
          <span class="chip af" data-type="all">Semua</span>
          <span class="chip af" data-type="add">Tambah</span>
          <span class="chip af" data-type="extend7">+7</span>
          <span class="chip af" data-type="setExp">Set Tanggal</span>
          <span class="chip af" data-type="noexp">No Exp</span>
          <span class="chip af" data-type="delete">Hapus</span>
          <span class="chip af" data-type="saveGlobal">Save Global</span>
          <span class="chip af" data-type="clearGlobal">Clear Global</span>
          <input id="auditFrom" type="date" title="Dari tanggal">
          <input id="auditTo" type="date" title="Sampai tanggal">
        </div>
        <div id="auditList" class="list" role="list"></div>
      </div>
    </section>

    <!-- About -->
    <section class="page" data-page="about">
      <div class="card">
        <h3>Tentang Panel</h3>
        <p class="muted">Kelola Global Key & daftar key dengan UI ringan. Pengaturan disinkronkan lintas perangkat. Tersedia filter status, highlight yang segera kedaluwarsa, statistik ringkas, dan audit ringan. Semua dialog modern; login tetap persisten saat refresh.</p>
      </div>
    </section>

    <!-- Login -->
    <section class="page login-only" data-page="login">
      <div class="card" style="max-width:480px;margin-inline:auto">
        <h3>Login Admin</h3>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="email" type="email" placeholder="Email" autocomplete="username">
        </div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="position:relative;width:100%">
            <input id="password" type="password" placeholder="Password" autocomplete="current-password">
            <button id="togglePass" class="btn small" style="position:absolute;right:6px;top:6px">Lihat</button>
          </div>
        </div>
        <div class="row" style="display:flex;justify-content:center">
          <button id="btnLogin" class="btn">Sign In</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav id="bottomnav" class="bottomnav" role="navigation" aria-label="Navigasi utama">
    <a href="#dashboard" data-route="dashboard" id="bn-home" aria-current="page">
      <svg class="bi" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5 12 3l9 6.5"/><path d="M5 10v10h14V10"/></svg>
      <span>Home</span>
    </a>
    <a href="#keys" data-route="keys" id="bn-keys">
      <svg class="bi" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="7" cy="8" r="3"/><path d="M10 8h10l-2 2 2 2-2 2 2 2"/></svg>
      <span>Daftar Key</span>
    </a>
  </nav>

  <!-- Splash boot -->
  <div id="boot"><span class="muted">Memuat…</span></div>

  <!-- Toast -->
  <div id="toast"></div>

  <!-- Modal Set Tanggal -->
  <div id="modalDateWrap" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <h3 id="modalTitle">Set Tanggal Kadaluarsa</h3>
      <div class="muted">Format: <b>Tanggal Bulan Tahun</b></div>
      <input id="modalDate" type="date">
      <div class="modal-actions">
        <button id="modalCancel" class="btn ghost">Batal</button>
        <button id="modalSave" class="btn">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div id="modalConfirmWrap" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Konfirmasi</h3>
      <div id="confirmMsg" class="muted">Yakin?</div>
      <div class="modal-actions">
        <button id="confirmCancel" class="btn ghost">Batal</button>
        <button id="confirmOk" class="btn">Lanjut</button>
      </div>
    </div>
  </div>

  <script type="module">
    /* Firebase (tanpa proteksi ekstra) */
    const ADMIN_UID = "4CCiNyEyTvSUPnY6Ugd9PzAU1df2";
    const firebaseConfig = {
      apiKey: "AIzaSyAJ2YitGgxTI8k440TmWUHgntkTLSqkX3c",
      authDomain: "dialog-vip-only-key.firebaseapp.com",
      databaseURL: "https://dialog-vip-only-key-default-rtdb.firebaseio.com",
      projectId: "dialog-vip-only-key",
      storageBucket: "dialog-vip-only-key.firebasestorage.app",
      messagingSenderId: "405714783893",
      appId: "1:405714783893:web:9cf697f2104b91958ed59c",
      measurementId: "G-YKCTBR2857"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove, off, push } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});
    const db   = getDatabase(app);

    /* Utils */
    const $  = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>el.querySelectorAll(s);
    const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; clearTimeout(window._t); window._t=setTimeout(()=>el.style.display="none",2000); }
    const fmtDate = (ms)=> ms ? new Date(ms).toLocaleDateString("id-ID", { day:"2-digit", month:"long", year:"numeric" }) : "Permanen";
    const toEOD = (Y,M,D)=> new Date(Y,M-1,D,23,59,59,999).getTime();
    const fromInputDate = (v)=>{const [Y,M,D]=v.split("-").map(n=>parseInt(n,10)); return {Y,M,D};};
    const nowMs = ()=>Date.now();

    const protectedRoutes = new Set(["dashboard","keys","settings","audit"]);

    /* Drawer a11y */
    const menuBtn = $("#menuBtn");
    const drawer  = $("#drawer");
    const backdrop= $("#backdrop");
    drawer.setAttribute("aria-hidden","true");
    try{ drawer.inert = true; }catch{}

    function openDrawer(){
      drawer.classList.add("open"); backdrop.classList.add("show");
      drawer.removeAttribute("aria-hidden"); try{ drawer.inert = false; }catch{}
      menuBtn.setAttribute("aria-expanded","true");
      const first = drawer.querySelector(".nav a") || drawer; (first instanceof HTMLElement ? first : drawer).focus();
    }
    function closeDrawer(){
      if (drawer.contains(document.activeElement)) { menuBtn.focus(); }
      drawer.classList.remove("open"); backdrop.classList.remove("show");
      drawer.setAttribute("aria-hidden","true"); try{ drawer.inert = true; }catch{}
      menuBtn.setAttribute("aria-expanded","false");
    }
    menuBtn.onclick=openDrawer; backdrop.onclick=closeDrawer;
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && drawer.classList.contains("open")){ e.preventDefault(); closeDrawer(); }});

    /* Routing */
    const isAuthed = ()=> auth.currentUser && auth.currentUser.uid===ADMIN_UID;
    function hardGuard(name){ return protectedRoutes.has(name)&&!isAuthed() ? "login" : name; }
    function updateBottomNav(name){
      $$("#bottomnav a").forEach(a=>{
        const active = a.dataset.route===name;
        a.classList.toggle("active", active);
        a.setAttribute("aria-current", active ? "page" : "false");
      });
    }
    function route(name){
      name = hardGuard(name);
      $$(".page").forEach(p=>p.classList.toggle("show",p.dataset.page===name));
      $$(".nav a").forEach(a=>a.classList.toggle("active",a.dataset.route===name));
      updateBottomNav(name);
      if(isAuthed()){ localStorage.setItem("gx:route", name); } else { localStorage.removeItem("gx:route"); }
      closeDrawer();
      try{ document.scrollingElement.scrollTo({top:0,behavior:"smooth"}); }catch{}
    }
    $$(".nav a").forEach(a=>a.onclick=(e)=>{e.preventDefault(); route(a.dataset.route);});
    $$("#bottomnav a").forEach(a=>a.addEventListener("click",(e)=>{ e.preventDefault(); route(a.dataset.route); }, {passive:false}));

    /* UI refs */
    const globalKey=$("#globalKey"), btnSaveGlobal=$("#btnSaveGlobal"), btnClearGlobal=$("#btnClearGlobal");
    const newKey=$("#newKey"), btnGen=$("#btnGen"), exp=$("#exp"), btnAdd=$("#btnAdd"), createKeyCard=$("#createKeyCard");
    const keyList=$("#keyList"), search=$("#search");
    const kpiKeys=$("#kpiKeys"), kpiExp=$("#kpiExp");
    const barFill=$("#barFill"), barLabel=$("#barLabel"), weekStats=$("#weekStats");
    const dense=$("#dense"), reduce=$("#reduce"), sortExpired=$("#sortExpired"), hideGlobal=$("#hideGlobal"), allowSelect=$("#allowSelect"), lightMode=$("#lightMode");
    const email=$("#email"), password=$("#password"), btnLogin=$("#btnLogin");
    const btnSignOut=$("#btnSignOut");
    const globalKeyCard=$("#globalKeyCard");
    const syncInfo=$("#syncInfo"), dot=$("#dot"), syncText=$("#syncText");

    /* ===== Settings Sync (Local + Remote) ===== */
    const SETTINGS_PATH = (uid)=>`auth/settings/${uid}`;
    function readLocalSettings(){
      return {
        dense: localStorage.getItem("gx:dense")==="1",
        reduce: localStorage.getItem("gx:reduce")==="1",
        sortExpired: localStorage.getItem("gx:sortExp")==="1",
        hideGlobal: localStorage.getItem("gx:hideGlobal")==="1",
        allowSelect: localStorage.getItem("gx:allowSelect")==="1",
        light: localStorage.getItem("gx:light")==="1",
        statusFilter: localStorage.getItem("gx:statusFilter")||"all",
        updatedAt: parseInt(localStorage.getItem("gx:settingsUpdatedAt")||"0",10)||0
      };
    }
    function writeLocalSettings(obj){
      localStorage.setItem("gx:dense", obj.dense?"1":"0");
      localStorage.setItem("gx:reduce", obj.reduce?"1":"0");
      localStorage.setItem("gx:sortExp", obj.sortExpired?"1":"0");
      localStorage.setItem("gx:hideGlobal", obj.hideGlobal?"1":"0");
      localStorage.setItem("gx:allowSelect", obj.allowSelect?"1":"0");
      localStorage.setItem("gx:light", obj.light?"1":"0");
      localStorage.setItem("gx:statusFilter", obj.statusFilter||"all");
      localStorage.setItem("gx:settingsUpdatedAt", String(obj.updatedAt||Date.now()));
    }
    function applySettingsToDOM(obj){
      dense.checked = !!obj.dense; reduce.checked=!!obj.reduce; sortExpired.checked=!!obj.sortExpired;
      hideGlobal.checked=!!obj.hideGlobal; allowSelect.checked=!!obj.allowSelect; lightMode.checked=!!obj.light;
      document.body.classList.toggle('dense', dense.checked);
      document.body.classList.toggle('reduce', reduce.checked);
      document.body.classList.toggle('allow-select', allowSelect.checked);
      document.body.classList.toggle('light', lightMode.checked);
      globalKeyCard.classList.toggle('hide', hideGlobal.checked);
      document.documentElement.style.scrollBehavior = reduce.checked?"auto":"smooth";
      setFilterChip(obj.statusFilter||"all");
    }
    applySettingsToDOM(readLocalSettings());

    let pushing=false, remoteReady=false;
    function currentSettings(){
      return {
        dense: dense.checked, reduce: reduce.checked, sortExpired: sortExpired.checked,
        hideGlobal: hideGlobal.checked, allowSelect: allowSelect.checked, light: lightMode.checked,
        statusFilter: getFilter(), updatedAt: Date.now()
      };
    }
    function pushSettings(uid){
      if(!uid) return;
      const data=currentSettings(); pushing=true;
      set(ref(db, SETTINGS_PATH(uid)), data).catch(()=>{}).finally(()=>{pushing=false});
      writeLocalSettings(data);
    }
    function startSettingsSync(uid){
      onValue(ref(db, SETTINGS_PATH(uid)), (s)=>{
        const remote = s.val()||{}; const local=readLocalSettings();
        const rAt=remote.updatedAt||0, lAt=local.updatedAt||0;
        if(pushing){ remoteReady=true; return; }
        if(rAt===0 && lAt>0){ pushSettings(uid); remoteReady=true; return; }
        if(rAt>lAt){ writeLocalSettings(remote); applySettingsToDOM(remote); }
        else if(rAt<lAt && remoteReady){ pushSettings(uid); }
        remoteReady=true;
      });
    }
    let syncTimer=null;
    function scheduleSync(uid){ clearTimeout(syncTimer); syncTimer=setTimeout(()=>pushSettings(uid), 250); }
    ;[dense,reduce,sortExpired,hideGlobal,allowSelect,lightMode].forEach(el=>{
      el.addEventListener("change", ()=>{
        const data=currentSettings(); applySettingsToDOM(data); writeLocalSettings(data);
        if(isAuthed()) scheduleSync(auth.currentUser.uid);
        if(el===sortExpired) render();
      });
    });

    /* Data listeners + offline cache */
    let cache = {}; // { key: {exp:number} }
    let audits = [];
    let lastSyncAt = 0;
    let selfWriteAt = 0; // suppress remote toast
    const listeners=[];
    function startData(){
      stopData();
      listeners.push(onValue(ref(db,"auth/globalKey"), s=>{ globalKey.value = s.exists()? (s.val()||"") : ""; }));
      listeners.push(onValue(ref(db,"auth/keys"), s=>{
        const v = s.val()||{};
        const serialized = JSON.stringify(v);
        if(JSON.stringify(cache)!==serialized){
          cache = v;
          localStorage.setItem("gx:cacheKeys", serialized);
          render();
          lastSyncAt = Date.now(); updateSyncBadge(true);
          if(Date.now()-selfWriteAt>1200){ toast("Data diperbarui"); }
        }
      }));
      listeners.push(onValue(ref(db,"auth/auditLog"), s=>{
        const v = s.val()||{};
        audits = Object.values(v).sort((a,b)=>(b.ts||0)-(a.ts||0)).slice(0,500);
        localStorage.setItem("gx:auditCache", JSON.stringify(audits));
        renderAudit(); updateWeekStats();
      }));
    }
    function stopData(){
      try{ off(ref(db,"auth/globalKey")); off(ref(db,"auth/keys")); off(ref(db,"auth/auditLog")); }catch{}
      listeners.length=0;
    }

    // Load offline cache first (jaga-jaga)
    try{
      const c = localStorage.getItem("gx:cacheKeys"); if(c){ cache = JSON.parse(c); render(); }
      const a = localStorage.getItem("gx:auditCache"); if(a){ audits = JSON.parse(a); renderAudit(); updateWeekStats(); }
    }catch{}

    // Online/offline indicator
    function updateSyncBadge(online){
      const d = $("#dot"); const t=$("#syncText");
      if(online===undefined){ online = navigator.onLine; }
      d.classList.toggle("on", online); d.classList.toggle("off", !online);
      const label = online ? ("Online · "+(lastSyncAt? new Date(lastSyncAt).toLocaleTimeString("id-ID",{hour:"2-digit",minute:"2-digit"}) : "--:--")) : "Offline";
      t.textContent = label;
    }
    window.addEventListener("online", ()=>{ updateSyncBadge(true); toast("Kembali online"); });
    window.addEventListener("offline", ()=>{ updateSyncBadge(false); toast("Offline – menampilkan cache"); });
    updateSyncBadge();

    /* Auth state */
    onAuthStateChanged(auth, (user)=>{
      if(user && user.uid===ADMIN_UID){
        startSettingsSync(user.uid);
        updateNav(true); startData();
        route(localStorage.getItem("gx:route") || "dashboard");
      }else{
        stopData(); updateNav(false); route("login");
        if(user && user.uid!==ADMIN_UID){ signOut(auth).catch(()=>{}); toast("Bukan admin"); }
      }
      document.body.classList.remove("booting"); $("#boot")?.remove();
    });
    function updateNav(authed){
      document.body.classList.toggle("authed", !!authed);
      document.body.classList.toggle("noauth", !authed);
      btnSignOut.classList.toggle("hide", !authed);
    }

    /* Login UX */
    $("#togglePass").addEventListener("click", ()=>{
      const pw=$("#password"); const t=pw.getAttribute("type")==="password"?"text":"password";
      pw.setAttribute("type", t); $("#togglePass").textContent=(t==="password"?"Lihat":"Sembunyikan"); pw.focus();
    });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Enter" && $(".page.show")?.dataset.page==="login"){ btnLogin.click(); }});
    btnLogin.addEventListener("click", async ()=>{
      const em=(email.value||"").trim(); const pw=password.value||"";
      if(!em||!pw){ toast("Isi email & password"); return; }
      try{ btnLogin.disabled=true; btnLogin.textContent="Masuk…"; await signInWithEmailAndPassword(auth, em, pw); toast("Login sukses"); }
      catch{ toast("Login gagal"); }
      finally{ btnLogin.disabled=false; btnLogin.textContent="Sign In"; }
    });
    btnSignOut.onclick = async ()=>{ try{ btnSignOut.disabled=true; await signOut(auth); toast("Signed out"); route("login"); }catch{}finally{ btnSignOut.disabled=false; } };

    /* Anti salin di luar input */
    const allowCtx=(el)=>!!el&&(el.closest('input,textarea,[contenteditable="true"]'));
    document.addEventListener('copy',e=>{ if(!document.body.classList.contains('allow-select')&&!allowCtx(document.activeElement)) e.preventDefault(); });
    document.addEventListener('cut', e=>{ if(!document.body.classList.contains('allow-select')&&!allowCtx(document.activeElement)) e.preventDefault(); });
    document.addEventListener('contextmenu', e=>{ if(!document.body.classList.contains('allow-select')&&!allowCtx(e.target)) e.preventDefault(); }, {passive:false});

    /* ===== Filter status chips ===== */
    function getFilter(){ return localStorage.getItem("gx:statusFilter") || "all"; }
    function setFilterChip(val){
      localStorage.setItem("gx:statusFilter", val);
      $$(".chip.filter").forEach(c=>c.classList.toggle("active", c.dataset.filter===val));
    }
    document.addEventListener("click",(e)=>{
      const f = e.target.closest(".chip.filter"); if(!f)return;
      const val=f.dataset.filter; setFilterChip(val); render();
      if(isAuthed()) scheduleSync(auth.currentUser.uid);
    });

    /* ===== Modal Set Tanggal ===== */
    const modalDateWrap=$("#modalDateWrap"), modalDate=$("#modalDate"), modalSave=$("#modalSave"), modalCancel=$("#modalCancel");
    let modalKey=null;
    function openModalSetDate(key, currMs){
      modalKey=key;
      const d = currMs? new Date(currMs) : new Date();
      const pad=n=>String(n).padStart(2,"0");
      modalDate.value = `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
      modalDateWrap.classList.add("show"); modalDateWrap.setAttribute("aria-hidden","false");
      modalDate.focus();
    }
    function closeModalDate(){ modalKey=null; modalDateWrap.classList.remove("show"); modalDateWrap.setAttribute("aria-hidden","true"); }
    modalCancel.onclick=closeModalDate;
    modalDateWrap.addEventListener("click",(e)=>{ if(e.target===modalDateWrap) closeModalDate(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalDateWrap.classList.contains("show")) closeModalDate(); });
    modalSave.onclick = async ()=>{
      if(!modalKey) return closeModalDate();
      const v=(modalDate.value||"").trim(); if(!v) return closeModalDate();
      const {Y,M,D}=fromInputDate(v); const ms=toEOD(Y,M,D);
      selfWriteAt=Date.now();
      await update(ref(db,"auth/keys/"+modalKey), {exp: ms}).then(()=>audit("setExp",{key:modalKey,exp:ms}));
      toast("Tanggal di-set"); closeModalDate();
    };

    /* ===== Modal Konfirmasi ===== */
    const modalConfirmWrap=$("#modalConfirmWrap"), confirmMsg=$("#confirmMsg"), confirmOk=$("#confirmOk"), confirmCancel=$("#confirmCancel");
    let confirmResolver=null;
    function confirmDialog(msg="Yakin?"){
      confirmMsg.textContent = msg;
      modalConfirmWrap.classList.add("show"); modalConfirmWrap.setAttribute("aria-hidden","false");
      return new Promise((res)=>{
        confirmResolver = (v)=>{ modalConfirmWrap.classList.remove("show"); modalConfirmWrap.setAttribute("aria-hidden","true"); res(v); };
      });
    }
    confirmCancel.onclick=()=>confirmResolver&&confirmResolver(false);
    confirmOk.onclick=()=>confirmResolver&&confirmResolver(true);
    modalConfirmWrap.addEventListener("click",(e)=>{ if(e.target===modalConfirmWrap) confirmResolver&&confirmResolver(false); });

    /* Render keys + stats */
    function render(){
      const ks = Object.keys(cache||{});
      let expCount=0; let soonCount=0; let activeCount=0; let permCount=0;
      const now=Date.now();
      for(const k of ks){
        const v=cache[k]?.exp||0;
        if(v===0){ permCount++; activeCount++; continue; }
        if(now>v) { expCount++; continue; }
        if((v-now)<=3*864e5) { soonCount++; }
        activeCount++;
      }
      kpiKeys.textContent = String(ks.length);
      kpiExp.textContent  = String(expCount);

      // progress bar aktif vs expired
      const total = Math.max(ks.length,1);
      const pct = Math.round((activeCount-expCount)/total*100);
      barFill.style.width = pct+"%";
      barLabel.textContent = pct+"% aktif";

      keyList.innerHTML="";
      const q = (search?.value||"").trim().toUpperCase();
      const filt = getFilter();
      const frag = document.createDocumentFragment();

      const sorted = ks.sort((a,b)=>{
        if(sortExpired.checked){
          const ea=(cache[a]?.exp||0)&&now>(cache[a].exp);
          const eb=(cache[b]?.exp||0)&&now>(cache[b].exp);
          if(ea!==eb) return eb - ea; // expired duluan
        }
        return a.localeCompare(b);
      });

      for(const k of sorted){
        const expMs = cache[k]?.exp||0;
        const expired = expMs && now>expMs;
        const soon = !expired && expMs && (expMs - now) <= (3*864e5);
        const permanent = expMs===0;

        // Filter status
        if(filt==="active" && (expired)) continue;
        if(filt==="soon" && !soon) continue;
        if(filt==="expired" && !expired) continue;
        if(filt==="permanent" && !permanent) continue;

        if(q && !k.toUpperCase().includes(q)) continue;

        const row=document.createElement("div"); row.className="item";

        // Row 1: key + pill kanan atas
        const head=document.createElement("div"); head.className="row1";
        const keySpan=document.createElement("strong"); keySpan.className="grow"; keySpan.textContent=k;
        const status=document.createElement("span"); status.className="pill "+(expired?"exp":(soon?"soon":"ok"));
        status.textContent = expired?"Expired":(soon?"Segera Habis":"Aktif");
        head.appendChild(keySpan); head.appendChild(status);

        // Row 2: tanggal (Tanggal Bulan Tahun)
        const sub=document.createElement("div"); sub.className="row2 muted";
        sub.textContent = "Expire: "+fmtDate(expMs);

        // Row 3: actions
        const actions=document.createElement("div"); actions.className="row3";
        const mk=(txt,action)=>{ const b=document.createElement("button"); b.className="btn small"; b.textContent=txt; b.dataset.key=k; b.dataset.action=action; return b; };
        actions.appendChild(mk("Copy","copy"));
        actions.appendChild(mk("+7","add7"));
        actions.appendChild(mk("No Exp","noexp"));
        actions.appendChild(mk("Tanggal…","setdate"));
        const del=mk("Hapus","del"); del.style.background="#2a1212"; del.style.borderColor="#5d2a2a"; actions.appendChild(del);

        row.appendChild(head); row.appendChild(sub); row.appendChild(actions);
        frag.appendChild(row);
      }

      if(!frag.childNodes.length){
        const empty=document.createElement("div"); empty.className="item"; empty.innerHTML='<span class="muted">Tidak ada hasil.</span>'; frag.appendChild(empty);
      }
      keyList.appendChild(frag);
    }

    /* Weekly stats from audit (7 hari terakhir) */
    function updateWeekStats(){
      const since = Date.now() - 7*864e5;
      let add=0, ext=0, exp=0;
      for(const a of audits){
        if(!a.ts || a.ts<since) break;
        if(a.type==="add") add++;
        else if(a.type==="extend7") ext++;
        else if(a.type==="delete") exp++;
      }
      weekStats.textContent = `Statistik mingguan: +${add} tambah, +${ext} perpanjang, ${exp} hapus`;
    }

    /* Key actions */
    document.addEventListener("click",(e)=>{
      const b=e.target.closest("button[data-action]"); if(!b) return;
      const k=b.dataset.key, act=b.dataset.action;
      (async()=>{
        try{
          if(act==="copy"){
            await navigator.clipboard.writeText(k); toast("Disalin");
          } else if(act==="add7"){
            const cur=cache[k]?.exp||0;
            const base=Math.max(cur||0, Date.now());
            const ms = base + 7*864e5;
            selfWriteAt=Date.now();
            await update(ref(db,"auth/keys/"+k), {exp: ms});
            audit("extend7",{key:k,exp:ms});
            toast("+7 hari");
          } else if(act==="noexp"){
            selfWriteAt=Date.now();
            await update(ref(db,"auth/keys/"+k), {exp:0});
            audit("noexp",{key:k});
            toast("No Exp");
          } else if(act==="setdate"){
            openModalSetDate(k, cache[k]?.exp||0);
          } else if(act==="del"){
            const ok = await confirmDialog(`Hapus key: ${k}?`);
            if(!ok) return;
            selfWriteAt=Date.now();
            await remove(ref(db,"auth/keys/"+k));
            audit("delete",{key:k});
            toast("Dihapus");
          }
        }catch{ toast("Gagal"); }
      })();
    }, {passive:true});

    /* Form controls */
    btnGen.onclick = ()=>{
      const rand = ()=>Math.random().toString(36).slice(2,6).toUpperCase();
      newKey.value = `${rand()}-${rand()}-${rand()}-${rand()}`;
      newKey.focus();
    };
    btnAdd.onclick = async ()=>{
      const k=(newKey.value||"").trim(); if(!k) return toast("Isi key");
      const val=(exp.value||"").trim();
      let ms=0; if(val){ const {Y,M,D}=fromInputDate(val); ms=toEOD(Y,M,D); }
      selfWriteAt=Date.now();
      await update(ref(db,"auth/keys/"+k), {exp: ms});
      audit("add",{key:k,exp:ms});
      newKey.value=""; exp.value=""; toast("Ditambahkan");
    };
    btnSaveGlobal.onclick = async ()=>{ selfWriteAt=Date.now(); await set(ref(db,"auth/globalKey"), (globalKey.value||"").trim()); audit("saveGlobal",{}); toast("Global key disimpan"); };
    btnClearGlobal.onclick = async ()=>{ selfWriteAt=Date.now(); await set(ref(db,"auth/globalKey"), ""); globalKey.value=""; audit("clearGlobal",{}); toast("Dikosongkan"); };

    // Chips cepat tanggal
    document.addEventListener("click",(e)=>{
      const chip=e.target.closest(".chip[data-add]"); if(!chip) return;
      const add=parseInt(chip.dataset.add||"0",10);
      if(add===0){ exp.value=""; toast("Tanpa Exp"); return; }
      const d=new Date(); d.setDate(d.getDate()+add);
      const pad=n=>String(n).padStart(2,"0");
      exp.value=`${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`;
    });

    // Pencarian live
    const doLiveSearch = ()=> render();
    search?.addEventListener("input", doLiveSearch, {passive:true});
    search?.addEventListener("keyup", doLiveSearch, {passive:true});

    /* Audit render + filter */
    const auditSearch=$("#auditSearch"), auditFrom=$("#auditFrom"), auditTo=$("#auditTo");
    document.addEventListener("click",(e)=>{
      const af=e.target.closest(".chip.af"); if(!af) return;
      $$(".chip.af").forEach(x=>x.classList.toggle("active", x===af));
      renderAudit();
    });
    [auditSearch,auditFrom,auditTo].forEach(el=>el.addEventListener("input", ()=>renderAudit(), {passive:true}));

    function renderAudit(){
      const el=$("#auditList"); el.innerHTML="";
      const type = ($(".chip.af.active")?.dataset.type)||"all";
      const q = (auditSearch.value||"").toLowerCase();
      const from = auditFrom.value? new Date(auditFrom.value+"T00:00:00").getTime():0;
      const to   = auditTo.value?   new Date(auditTo.value+"T23:59:59").getTime():Infinity;

      const frag=document.createDocumentFragment();
      let shown=0;
      for(const a of audits){
        if(type!=="all" && a.type!==type) continue;
        if(a.ts && (a.ts<from || a.ts>to)) continue;
        const textBase =
          a.type==="add"       ? `Tambah key ${a.key} (Expire: ${fmtDate(a.exp||0)})` :
          a.type==="extend7"   ? `Perpanjang +7 hari: ${a.key} (Expire: ${fmtDate(a.exp||0)})` :
          a.type==="noexp"     ? `Set No Exp: ${a.key}` :
          a.type==="setExp"    ? `Set tanggal: ${a.key} (Expire: ${fmtDate(a.exp||0)})` :
          a.type==="delete"    ? `Hapus key ${a.key}` :
          a.type==="saveGlobal"? `Simpan Global Key` :
          a.type==="clearGlobal"?`Kosongkan Global Key` : a.type;

        const line = `${textBase} | by:${a.by||"-"}`;
        if(q && !line.toLowerCase().includes(q)) continue;

        const d = a.ts ? new Date(a.ts) : null;
        const dd = d ? d.toLocaleDateString("id-ID",{day:"2-digit",month:"long",year:"numeric"}) : "-";
        const item=document.createElement("div"); item.className="item";
        item.innerHTML = `<div class="row1"><strong class="grow">${textBase}</strong><span class="pill">${dd}</span></div><div class="row2 muted">UID: ${a.by||"-"}</div>`;
        frag.appendChild(item);
        shown++;
      }
      if(shown===0){
        const x=document.createElement("div"); x.className="item"; x.innerHTML='<span class="muted">Tidak ada data.</span>'; frag.appendChild(x);
      }
      el.appendChild(frag);
    }

    // Lite mode: perangkat RAM kecil
    try{ if('deviceMemory' in navigator && navigator.deviceMemory<=2){ document.body.classList.add('lite'); } }catch{}
  </script>
</body>
</html>
