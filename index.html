<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <title>GxMods Key Panel – Drawer</title>
  <style>
    /* ===== Reset mini */
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;background:#0b0f14;color:#e6edf3;-webkit-tap-highlight-color:transparent}
    a{color:inherit;text-decoration:none}
    button,input,select,textarea{font:inherit;color:inherit}
    img,svg{display:block;max-width:100%}

    :root{
      --bg:#0b0f14;--card:#0f1622;--line:#1a2331;--muted:#9fb1c3;
      --pri:#7c3aed;--ok:#19c37d;--r:16px; --shadow:0 6px 24px rgba(0,0,0,.28);
    }
    @media (prefers-reduced-motion: reduce){*{animation:none!important;transition:none!important;scroll-behavior:auto!important}}

    /* ===== Topbar */
    .topbar{position:sticky;top:0;z-index:40;height:56px;display:flex;align-items:center;gap:12px;padding:0 14px;background:#0c111b;border-bottom:1px solid var(--line)}
    .title{font-weight:700}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#0f1622;box-shadow:var(--shadow);cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .icon{width:20px;height:20px}

    /* ===== Drawer */
    .drawer{position:fixed;inset:0 auto 0 0;width:min(78%,320px);background:#0e1420;border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .16s ease-out;z-index:50;contain:paint}
    .drawer.open{transform:translateX(0)}
    .drawer .brand{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--line)}
    .nav{padding:8px}
    .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1px solid transparent}
    .nav a:hover{background:#0f1622}
    .nav a.active{border-color:#213048;background:#0f1622}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .16s ease;z-index:45}
    .backdrop.show{opacity:1;pointer-events:auto}

    /* ===== App */
    .app{min-height:calc(100dvh - 56px);padding:14px;display:flex;flex-direction:column;gap:14px}
    .page{display:none}
    .page.show{display:block}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:12px}
    .muted{color:var(--muted);font-size:.95rem}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}
    .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}

    /* ===== Inputs: DARK FORCE OVERRIDE ===== */
    input, select, textarea{
      width:100%;
      padding:12px;
      border-radius:12px;
      background:#0a0a0a!important;   /* paksa gelap */
      color:#ffffff!important;         /* teks putih */
      border:1px solid #30363d!important;
      outline:none;
      appearance:none;
      -webkit-appearance:none;
      -moz-appearance:none;
    }
    input::placeholder, textarea::placeholder{color:#9aa7b3}
    /* Autofill Chrome (biar gak kuning) */
    input:-webkit-autofill{
      -webkit-text-fill-color:#fff !important;
      box-shadow:0 0 0 1000px #0a0a0a inset !important;
      caret-color:#fff;
      border:1px solid #30363d !important;
    }
    /* Date input in dark */
    input[type="date"]{ color-scheme: dark; }
    input[type="date"]::-webkit-calendar-picker-indicator{ filter: invert(1) opacity(.85); }
    /* Search clear button */
    input[type="search"]::-webkit-search-cancel-button{ filter: invert(1); }
    /* Disabled look konsisten */
    input:disabled, textarea:disabled{opacity:.6}

    /* List Key */
    .list{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .item{display:grid;grid-template-columns:1fr auto auto;gap:10px;align-items:center;padding:12px;background:#0e1420;border-bottom:1px solid var(--line)}
    .item:nth-child(2n){background:#0d131e}
    .item:last-child{border-bottom:none}
    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:.8rem;white-space:nowrap}
    .ok{background:#10221a;border-color:#1f4e39;color:#9de7c4}
    .exp{background:#2a1414;border-color:#5d2a2a;color:#ffc8c8}
    .footer{margin-top:auto;color:var(--muted);font-size:.85rem;text-align:center;opacity:.9}
    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1622;cursor:pointer;user-select:none}

    /* Lite mode (RAM 2GB) */
    .lite .btn{box-shadow:none}
    .lite .card{box-shadow:none}

    /* Utilities */
    .hide{display:none!important}
  </style>
</head>
<body>
  <!-- Topbar -->
  <header class="topbar">
    <button id="menuBtn" class="btn" aria-label="Menu">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span>Menu</span>
    </button>
    <div class="title">GxMods Key Panel</div>
    <div class="grow"></div>
    <button id="btnSignOut" class="btn ghost hide">Sign Out</button>
  </header>

  <!-- Drawer -->
  <aside id="drawer" class="drawer" aria-hidden="true">
    <div class="brand"><strong>Menu</strong></div>
    <nav class="nav" id="nav">
      <a href="#dashboard" data-route="dashboard" class="active" data-auth="in">Dashboard</a>
      <a href="#keys" data-route="keys" data-auth="in">Daftar Key</a>
      <a href="#settings" data-route="settings" data-auth="in">Pengaturan</a>
      <a href="#about" data-route="about">Tentang</a>
      <a href="#login" data-route="login" id="navLogin" class="mobile-only" data-auth="out">Login</a>
    </nav>
  </aside>
  <div id="backdrop" class="backdrop"></div>

  <!-- App -->
  <main id="app" class="app">
    <!-- Dashboard -->
    <section class="page show" data-page="dashboard">
      <div class="grid">
        <div class="card">
          <h3>Status</h3>
          <div class="row" style="justify-content:space-between">
            <span class="muted">Key aktif</span><strong id="kpiKeys">0</strong>
          </div>
          <div class="row" style="justify-content:space-between">
            <span class="muted">Key expired</span><strong id="kpiExp">0</strong>
          </div>
          <p class="muted">Angka dari Firebase Realtime DB.</p>
        </div>

        <div class="card">
          <h3>Ringkasan</h3>
          <p class="muted">Kelola Global Key & daftar key di tab <strong>Daftar Key</strong>. Input sudah tema gelap total.</p>
        </div>
      </div>
    </section>

    <!-- Keys -->
    <section class="page" data-page="keys">
      <!-- Global Key -->
      <div class="card" id="globalKeyCard">
        <h3>Global Key</h3>
        <div class="row">
          <input id="globalKey" type="text" placeholder="Kosongkan jika tidak pakai"/>
          <button id="btnSaveGlobal" class="btn small">Simpan</button>
          <button id="btnClearGlobal" class="btn small">Hapus</button>
        </div>
        <p class="muted">Nilai disimpan di <code>auth/globalKey</code>.</p>
      </div>

      <!-- Buat Key -->
      <div class="card">
        <h3>Buat Key</h3>
        <div class="row">
          <input id="newKey" type="text" placeholder="Key (atau klik Generate)"/>
          <button id="btnGen" class="btn small">Generate</button>
        </div>
        <div class="row">
          <label class="muted" for="exp">Tanggal kadaluarsa (opsional)</label>
          <input id="exp" type="date" inputmode="none" placeholder="yyyy-mm-dd"/>
          <span class="chip" data-add="7">+7 hari</span>
          <span class="chip" data-add="0">Tanpa Exp</span>
          <div class="grow"></div>
          <button id="btnAdd" class="btn small">Tambah</button>
        </div>
      </div>

      <!-- Daftar Key -->
      <div class="card">
        <div class="row" style="justify-content:space-between;align-items:center">
          <h3 style="margin:0">Daftar Key</h3>
          <input id="search" type="search" placeholder="Cari key…" style="min-width:160px;max-width:260px">
        </div>
        <div id="keyList" class="list" role="list"></div>
      </div>

      <div class="footer">Struktur: <code>auth/globalKey</code> & <code>auth/keys/{key} = {"exp":ms}</code>.</div>
    </section>

    <!-- Settings -->
    <section class="page" data-page="settings">
      <div class="card">
        <h3>Ringan</h3>
        <label class="chip"><input id="dense" type="checkbox"> List rapat</label>
        <label class="chip"><input id="reduce" type="checkbox"> Kurangi animasi</label>
      </div>
    </section>

    <!-- About -->
    <section class="page" data-page="about">
      <div class="card">
        <h3>Tentang</h3>
        <p class="muted">Optimasi RAM 2 GB: efek minimal, event delegation tunggal, dan lite mode otomatis.</p>
      </div>
    </section>

    <!-- Login -->
    <section class="page" data-page="login">
      <div class="card">
        <h3>Login Admin</h3>
        <div class="row"><input id="email" type="email" placeholder="Email" autocomplete="username"></div>
        <div class="row"><input id="password" type="password" placeholder="Password" autocomplete="current-password"></div>
        <div class="row" style="justify-content:flex-end">
          <button id="btnLogin" class="btn">Sign In</button>
        </div>
        <p class="muted">Hanya UID admin yang diizinkan.</p>
      </div>
    </section>
  </main>

  <div id="toast" style="position:fixed;right:10px;bottom:10px;background:#111827;border:1px solid #263248;padding:10px 14px;border-radius:10px;box-shadow:var(--shadow);display:none"></div>

  <script type="module">
    /* ====== Firebase config */
    const ADMIN_UID = "4CCiNyEyTvSUPnY6Ugd9PzAU1df2";
    const firebaseConfig = {
      apiKey: "AIzaSyAJ2YitGgxTI8k440TmWUHgntkTLSqkX3c",
      authDomain: "dialog-vip-only-key.firebaseapp.com",
      databaseURL: "https://dialog-vip-only-key-default-rtdb.firebaseio.com",
      projectId: "dialog-vip-only-key",
      storageBucket: "dialog-vip-only-key.firebasestorage.app",
      messagingSenderId: "405714783893",
      appId: "1:405714783893:web:9cf697f2104b91958ed59c",
      measurementId: "G-YKCTBR2857"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db   = getDatabase(app);

    /* ===== Util & state */
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>el.querySelectorAll(s);
    const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; clearTimeout(window._t); window._t=setTimeout(()=>el.style.display="none",2000); }
    const route = (name)=>{ $$(".page").forEach(p=>p.classList.toggle("show",p.dataset.page===name)); $$(".nav a").forEach(a=>a.classList.toggle("active",a.dataset.route===name)); localStorage.setItem("gx:route",name); closeDrawer(); }
    const drawer=$("#drawer"), backdrop=$("#backdrop");
    const openDrawer=()=>{drawer.classList.add("open"); backdrop.classList.add("show"); drawer.setAttribute("aria-hidden","false");};
    const closeDrawer=()=>{drawer.classList.remove("open"); backdrop.classList.remove("show"); drawer.setAttribute("aria-hidden","true");};

    // Lite mode untuk RAM kecil
    try{ if('deviceMemory' in navigator && navigator.deviceMemory<=2){ document.body.classList.add('lite'); } }catch{}

    // Routing
    $("#menuBtn").onclick=openDrawer; backdrop.onclick=closeDrawer;
    $$(".nav a").forEach(a=>a.onclick=(e)=>{e.preventDefault(); route(a.dataset.route);});
    route(localStorage.getItem("gx:route") || "dashboard");

    // UI refs
    const globalKey=$("#globalKey"), btnSaveGlobal=$("#btnSaveGlobal"), btnClearGlobal=$("#btnClearGlobal");
    const newKey=$("#newKey"), btnGen=$("#btnGen"), exp=$("#exp"), btnAdd=$("#btnAdd");
    const keyList=$("#keyList"), search=$("#search");
    const kpiKeys=$("#kpiKeys"), kpiExp=$("#kpiExp");
    const dense=$("#dense"), reduce=$("#reduce");
    const email=$("#email"), password=$("#password"), btnLogin=$("#btnLogin");
    const btnSignOut=$("#btnSignOut");

    // Settings persist
    dense.checked = localStorage.getItem("gx:dense")==="1";
    reduce.checked = localStorage.getItem("gx:reduce")==="1";
    dense.onchange = ()=>{ localStorage.setItem("gx:dense", dense.checked?"1":"0"); render(); };
    reduce.onchange = ()=>{ document.documentElement.style.scrollBehavior = reduce.checked?"auto":"smooth"; localStorage.setItem("gx:reduce", reduce.checked?"1":"0"); };

    // ===== Auth & Nav visibility
    function updateNav(user){
      document.querySelectorAll('.nav a').forEach(a=>{
        const need=a.dataset.auth;
        if(need==="in") a.classList.toggle("hide", !user);
        else if(need==="out") a.classList.toggle("hide", !!user);
      });
      btnSignOut.classList.toggle("hide", !user);
    }

    onAuthStateChanged(auth, (user)=>{
      if(user && user.uid===ADMIN_UID){
        updateNav(true);
        startData();
        const last = localStorage.getItem("gx:route") || "dashboard";
        if(last==="login") route("dashboard"); else route(last);
      }else{
        updateNav(false);
        route("login");
        if(user && user.uid!==ADMIN_UID){ signOut(auth); toast("Bukan admin"); }
      }
    });

    document.getElementById("btnLogin").onclick = async ()=>{
      try{
        btnLogin.disabled = true; btnLogin.textContent = "Masuk…";
        await signInWithEmailAndPassword(auth, (email.value||"").trim(), password.value||"");
        toast("Login sukses");
      }catch(err){
        toast("Login gagal");
      }finally{
        btnLogin.disabled = false; btnLogin.textContent = "Sign In";
      }
    };

    btnSignOut.onclick = async ()=>{
      try{
        btnSignOut.disabled = true;
        await signOut(auth);
        toast("Signed out");
        route("login");
      }catch{}finally{ btnSignOut.disabled = false; }
    };

    // ===== Data
    let cache = {}; // { key: {exp:number} }
    function startData(){
      onValue(ref(db,"auth/globalKey"), s=>{ globalKey.value = s.exists()? (s.val()||"") : ""; });
      onValue(ref(db,"auth/keys"), s=>{ cache = s.val()||{}; render(); });
    }

    function render(){
      const ks = Object.keys(cache||{});
      let expCount=0;
      for(const k of ks){ const v=cache[k]?.exp||0; if(v && Date.now()>v) expCount++; }
      kpiKeys.textContent = String(ks.length);
      kpiExp.textContent  = String(expCount);

      // List
      keyList.innerHTML="";
      const q = (search.value||"").trim().toUpperCase();
      const frag = document.createDocumentFragment();
      ks.sort();
      for(const k of ks){
        if(q && !k.toUpperCase().includes(q)) continue;
        const expMs=cache[k]?.exp||0;
        const expired = expMs && Date.now()>expMs;

        const row = document.createElement("div");
        row.className="item";
        if(dense.checked) row.style.padding="10px 10px";

        const left = document.createElement("div");
        left.style.display="grid"; left.style.gap="4px";
        const expStr = expMs? new Date(expMs).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}) : "Permanen";
        left.innerHTML = `<strong style="word-break:break-all">${k}</strong><span class="muted" style="font-size:.85rem">Expire: ${expStr}</span>`;

        const status = document.createElement("span");
        status.className="pill "+(expired?"exp":"ok");
        status.textContent = expired?"Expired":"Aktif";

        const right = document.createElement("div");
        right.style.display="flex"; right.style.gap="6px"; right.style.flexWrap="wrap";
        const mk=(txt,action)=>{ const b=document.createElement("button"); b.className="btn small"; b.textContent=txt; b.dataset.key=k; b.dataset.action=action; return b; };
        right.appendChild(mk("Copy","copy"));
        right.appendChild(mk("+7","add7"));
        right.appendChild(mk("No Exp","noexp"));
        right.appendChild(mk("Tanggal…","setdate"));
        const del=mk("Hapus","del"); del.style.background="#2a1212"; del.style.borderColor="#5d2a2a"; right.appendChild(del);

        row.appendChild(left); row.appendChild(status); row.appendChild(right);
        frag.appendChild(row);
      }
      if(!frag.childNodes.length){
        const empty=document.createElement("div"); empty.className="item"; empty.innerHTML='<span class="muted">Belum ada data.</span>'; frag.appendChild(empty);
      }
      keyList.appendChild(frag);
    }

    // Actions
    document.addEventListener("click",(e)=>{
      const b=e.target.closest("button[data-action]"); if(!b) return;
      const k=b.dataset.key, act=b.dataset.action;
      (async()=>{
        try{
          if(act==="copy"){ await navigator.clipboard.writeText(k); toast("Disalin"); }
          else if(act==="add7"){ const cur=cache[k]?.exp||0; const base=Math.max(cur||0, Date.now()); await update(ref(db,"auth/keys/"+k), {exp: base + 7*864e5}); toast("+7 hari"); }
          else if(act==="noexp"){ await update(ref(db,"auth/keys/"+k), {exp:0}); toast("No Exp"); }
          else if(act==="setdate"){ const cur=cache[k]?.exp||0; const seed = cur? new Date(cur): new Date(); const pad=n=>String(n).padStart(2,"0"); const def=`${seed.getFullYear()}-${pad(seed.getMonth()+1)}-${pad(seed.getDate())}`; const v=prompt("YYYY-MM-DD (kosong = No Exp)", def); if(v===null) return; const ms = v.trim()===""?0:(()=>{ const [Y,M,D]=v.split("-").map(n=>parseInt(n,10)); return new Date(Y,M-1,D,23,59,59,999).getTime(); })(); await update(ref(db,"auth/keys/"+k), {exp: ms}); toast("Tanggal di-set"); }
          else if(act==="del"){ if(confirm(`Hapus key:\n${k}?`)){ await remove(ref(db,"auth/keys/"+k)); toast("Dihapus"); } }
        }catch{ toast("Gagal"); }
      })();
    }, {passive:true});

    // Controls
    document.getElementById("btnGen").onclick = ()=>{
      const rand = ()=>Math.random().toString(36).slice(2,6).toUpperCase();
      document.getElementById("newKey").value = `${rand()}-${rand()}-${rand()}-${rand()}`;
      document.getElementById("newKey").focus();
    };
    document.getElementById("btnAdd").onclick = async ()=>{
      const k=(document.getElementById("newKey").value||"").trim(); if(!k) return toast("Isi key");
      const val = (document.getElementById("exp").value||"").trim();
      let ms=0; if(val){ const [Y,M,D]=val.split("-").map(n=>parseInt(n,10)); ms=new Date(Y,M-1,D,23,59,59,999).getTime(); }
      await update(ref(db,"auth/keys/"+encodeURIComponent(k)), {exp: ms});
      document.getElementById("newKey").value=""; document.getElementById("exp").value="";
      toast("Ditambahkan");
    };
    document.getElementById("btnSaveGlobal").onclick = async ()=>{ await set(ref(db,"auth/globalKey"), (document.getElementById("globalKey").value||"").trim()); toast("Global key disimpan"); };
    document.getElementById("btnClearGlobal").onclick = async ()=>{ await set(ref(db,"auth/globalKey"), ""); document.getElementById("globalKey").value=""; toast("Dikosongkan"); };

    document.getElementById("search").addEventListener("input", ()=>render(), {passive:true});

    // Chip +7 / No Exp
    document.addEventListener("click",(e)=>{
      const chip=e.target.closest(".chip[data-add]"); if(!chip) return;
      const v = Number(chip.dataset.add||0);
      const exp=document.getElementById("exp");
      if(v===0){ exp.value=""; toast("Tanpa Exp"); return; }
      const base = new Date(); base.setDate(base.getDate()+v);
      const Y=base.getFullYear(), M=String(base.getMonth()+1).padStart(2,"0"), D=String(base.getDate()).padStart(2,"0");
      exp.value = `${Y}-${M}-${D}`; toast(`+${v} hari`);
    }, {passive:true});

    // Open last route
    (function initRoute(){
      const last = localStorage.getItem("gx:route");
      if(last) route(last);
    })();
  </script>
</body>
</html>
