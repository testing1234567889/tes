<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <!-- Tambah interactive-widget biar keyboard HP gak dorong layout -->
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, viewport-fit=cover, interactive-widget=overlays-content" />
  <meta name="theme-color" content="#0b0f14" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>GxMods Key Panel</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    :root{
      --bg:#0b0f14;--card:#0f1622;--line:#1a2331;--muted:#9fb1c3;
      --text:#e6edf3;--pri:#7c3aed;--ok:#19c37d;--warn:#f59e0b;
      --err:#ef4444;--chip:#1a2331;--chipOn:#1f2b3d;--ghost:#121a26;
      --glass:color-mix(in oklab, var(--card), white 4%);
    }
    body{margin:0;background:linear-gradient(180deg,#0b0f14,#0b0f14 40%,#0b0f14);color:var(--text);font:14px/1.4 system-ui,Segoe UI,Roboto,Ubuntu,Cantarell,Noto Sans,Arial}
    a{color:inherit;text-decoration:none}
    .muted{color:#9fb1c3}
    .ok{color:var(--ok)}.warn{color:var(--warn)}.err{color:var(--err)}
    .row{display:flex;align-items:center;gap:12px}
    .grow{flex:1 1 auto}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:12px;background:color-mix(in oklab, var(--pri), black 30%);border:1px solid color-mix(in oklab, var(--pri), black 45%);cursor:pointer;user-select:none}
    .btn.ghost{background:var(--ghost);border-color:var(--line)}
    .btn[disabled]{opacity:.6;cursor:not-allowed}
    .icon{width:18px;height:18px;stroke-width:2}
    .chip{display:inline-flex;align-items:center;gap:8px;background:var(--chip);border:1px solid var(--line);padding:8px 12px;border-radius:999px;cursor:pointer;user-select:none}
    .chip.active{background:var(--chipOn);border-color:#2a3650}
    .card{background:var(--glass);border:1px solid var(--line);border-radius:16px}
    .list{display:flex;flex-direction:column}
    .item{display:grid;grid-template-columns:1fr auto;gap:8px;padding:12px 14px;border-bottom:1px solid var(--line)}
    .item:last-child{border-bottom:none}
    .row-actions{display:flex;gap:8px;flex-wrap:wrap}
    .field{display:grid;gap:8px}
    .field .label{font-weight:600}
    .grid{display:grid;gap:12px}
    .grid.cols2{grid-template-columns:repeat(2,minmax(0,1fr))}
    .grid.cols3{grid-template-columns:repeat(3,minmax(0,1fr))}
    .topbar{position:sticky;top:0;z-index:60;height:56px;display:flex;align-items:center;gap:10px;padding:0 12px;background:color-mix(in oklab, var(--card), black 4%);border-bottom:1px solid var(--line);backdrop-filter:saturate(120%) blur(8px)}
    .title{font-weight:700}
    .container{max-width:980px;margin:16px auto;padding:0 12px}
    .drawer{position:fixed;inset:0;z-index:70;display:flex;pointer-events:none}
    .drawer .panel{width:280px;max-width:86vw;background:var(--card);border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .18s ease;border-radius:0 14px 14px 0}
    .drawer .backdrop{flex:1;background:rgba(0,0,0,.32);opacity:0;transition:opacity .18s ease}
    .drawer.open{pointer-events:auto}
    .drawer.open .panel{transform:none}
    .drawer.open .backdrop{opacity:1}
    .hide{display:none !important}
    input,textarea{user-select:text;-webkit-user-select:text}

    /* Inputs */
    body,button,input,select,textarea{color:var(--text)}
    .btn{color:var(--text)}
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]),
    select,textarea{
      width:100%;padding:14px;border-radius:12px;background:color-mix(in oklab, var(--card), black 12%);border:1px solid var(--line);outline:none;
      appearance:none;-webkit-appearance:none;-moz-appearance:none;font-size:16px
    }
    input::placeholder,textarea::placeholder{color:#9aa7b3}

    /* Topbar */
    .topbar .btn{background:transparent;border:1px solid var(--line)}
    .topbar .btn:hover{background:color-mix(in oklab, var(--card), white 4%)}

    /* Bottom nav */
    #bottomnav{position:sticky;bottom:0;z-index:50;background:color-mix(in oklab, var(--card), black 3%);border-top:1px solid var(--line)}
    #bottomnav .bar{display:flex;gap:8px;padding:8px;max-width:980px;margin:0 auto}
    #bottomnav a{flex:1;border-radius:12px;padding:10px;text-align:center;border:1px solid var(--line);background:var(--ghost)}
    #bottomnav a.active{border-color:color-mix(in oklab, var(--pri), black 30%);background:color-mix(in oklab, var(--pri), black 60%)}

    /* Pages */
    .page{display:none}
    .page.show{display:block}

    /* Modal */
    .modal{position:fixed;inset:0;z-index:90;background:rgba(0,0,0,.35);display:none;align-items:center;justify-content:center;padding:20px}
    .modal.show{display:flex}
    .modal-card{width:min(560px,92vw);background:var(--card);border:1px solid var(--line);border-radius:16px;padding:16px}
    .modal .modal-actions{display:flex;gap:8px;justify-content:flex-end;margin-top:12px}

    /* Toast */
    #toast{position:fixed;z-index:100;left:50%;bottom:18px;transform:translateX(-50%);display:none;gap:12px;align-items:center;background:var(--card);border:1px solid var(--line);padding:10px 14px;border-radius:14px}

    /* Poles UI tambahan (5 saran) */
    .btn:focus-visible{ outline:2px solid color-mix(in oklab, var(--pri), white 10%); outline-offset:2px }
    .chip{ transition: transform .08s ease, outline-color .15s ease }
    .chip:active{ transform: translateY(1px) }
    .item{ border-left:3px solid transparent }
    .item:hover{ border-left-color: var(--pri) }
    .offline-banner{ position:sticky; top:56px; z-index:59; background:#2b1f1f; color:#f2dede; border-bottom:1px solid #4a2f2f; padding:8px 16px; font-size:14px; }
    body.offline .btn, body.offline input, body.offline select, body.offline textarea{ opacity:.7 }
  </style>
</head>
<body class="booting">
  <div class="topbar" role="banner">
    <button id="menuBtn" class="btn" aria-label="Menu" aria-haspopup="true" aria-controls="drawer" aria-expanded="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" aria-hidden="true"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span>Menu</span>
    </button>
    <div class="title">GxMods Key Panel</div>
    <div id="offlineBanner" class="offline-banner hide" role="status">Mode Offline: semua fitur dimatikan sementara.</div>
    <div class="grow"></div>
    <button id="btnSignOut" class="btn ghost">Sign Out</button>
  </div>

  <div class="drawer" id="drawer" aria-hidden="true">
    <div class="panel">
      <div style="padding:12px;border-bottom:1px solid var(--line);font-weight:700">Navigasi</div>
      <div style="padding:12px;display:grid;gap:8px">
        <a class="chip" data-route="dashboard">Dashboard</a>
        <a class="chip" data-route="keys">Daftar Key</a>
        <a class="chip" data-route="settings">Pengaturan</a>
      </div>
    </div>
    <div class="backdrop"></div>
  </div>

  <div id="toast" role="status" aria-live="polite"></div>

  <div class="container">
    <!-- Pages -->
    <div id="page-dashboard" class="page show">
      <div class="card" style="padding:12px">
        <div class="row" style="gap:8px">
          <div class="title" style="font-size:16px">Ringkasan</div>
          <div class="grow"></div>
          <div id="filterChips" class="row" role="tablist" aria-label="Filter">
            <div class="chip active" data-filter="all" role="tab" aria-selected="true">Semua</div>
            <div class="chip" data-filter="active" role="tab" aria-selected="false">Aktif</div>
            <div class="chip" data-filter="expired" role="tab" aria-selected="false">Expired</div>
          </div>
        </div>
      </div>

      <div class="card" style="padding:12px;margin-top:12px">
        <div class="grid cols3">
          <div class="field"><div class="label">Key Global</div><input id="globalKey" placeholder="(opsional)"/></div>
          <div class="field"><div class="label">Tambah Key</div>
            <div class="row" style="gap:8px">
              <input id="newKey" placeholder="VIP-XXXX-XXXX" />
              <button id="btnGen" class="btn">Generate</button>
              <button id="btnAdd" class="btn">Tambah</button>
            </div>
          </div>
          <div class="field"><div class="label">Tanggal Exp</div>
            <input id="exp" type="date" />
          </div>
        </div>
        <div class="row" style="gap:8px; margin-top:10px;justify-content:flex-end">
          <button id="btnSaveGlobal" class="btn">Simpan Global</button>
          <button id="btnClearGlobal" class="btn ghost">Kosongkan Global</button>
          <button id="btnShareGlobal" class="btn">Share</button>
        </div>
      </div>

      <div class="card" style="padding:12px;margin-top:12px">
        <div class="row" style="gap:8px;align-items:center">
          <div class="label" style="font-weight:700">Daftar Key</div>
          <div class="grow"></div>
          <label class="row" style="gap:6px"><input type="checkbox" id="reduce"><span class="muted">Padat</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="sortExpired"><span class="muted">Expired di bawah</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="hideGlobal"><span class="muted">Sembunyikan Global</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="allowSelect"><span class="muted">Bisa Select</span></label>
        </div>
        <div id="list" class="list" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="page-keys" class="page">
      <div class="card" style="padding:12px">
        <div class="label" style="font-weight:700">Daftar Key</div>
        <div id="list2" class="list" style="margin-top:8px"></div>
      </div>
    </div>

    <div id="page-settings" class="page">
      <div class="card" style="padding:12px">
        <div class="label" style="font-weight:700">Pengaturan</div>
        <div class="grid cols2" style="margin-top:8px">
          <label class="row" style="gap:6px"><input type="checkbox" id="reduce2"><span class="muted">Padat</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="sortExpired2"><span class="muted">Expired di bawah</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="hideGlobal2"><span class="muted">Sembunyikan Global</span></label>
          <label class="row" style="gap:6px"><input type="checkbox" id="allowSelect2"><span>Bisa Select</span></label>
        </div>
      </div>
    </div>

    <div id="page-login" class="page">
      <div class="card" style="padding:12px">
        <div class="row" style="gap:8px">
          <div class="label" style="font-weight:700">Login</div>
          <div class="grow"></div>
          <button id="btnSignIn" class="btn">Google Sign-In</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal Tanggal -->
  <div id="modalDateWrap" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalDateTitle">
      <h3 id="modalDateTitle">Set Tanggal Exp</h3>
      <div class="field" style="margin-top:8px">
        <div class="label">Tanggal</div>
        <input id="modalDate" type="date" />
      </div>
      <div class="modal-actions">
        <button id="modalCancel" class="btn ghost">Batal</button>
        <button id="modalSave" class="btn">Simpan</button>
      </div>
    </div>
  </div>

  <!-- Modal Konfirmasi -->
  <div id="modalConfirmWrap" class="modal" aria-hidden="true">
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="confirmTitle">
      <h3 id="confirmTitle">Konfirmasi</h3>
      <div id="confirmMsg" class="muted">Yakin?</div>
      <div class="modal-actions">
        <button id="confirmCancel" class="btn ghost">Batal</button>
        <button id="confirmOk" class="btn">Lanjut</button>
      </div>
    </div>
  </div>

  <nav id="bottomnav">
    <div class="bar">
      <a data-route="dashboard" class="active">Dashboard</a>
      <a data-route="keys">Daftar Key</a>
      <a data-route="settings">Pengaturan</a>
    </div>
  </nav>

  <script type="module">
    /* Firebase (tetap sama seperti file kamu) */
    const ADMIN_UID = "4CCiNyEyTvSUPnY6Ugd9PzAU1df2";
    const firebaseConfig = {
      apiKey: "AIzaSyAJ2YitGgxTI8k440TmWUHgntkTLSqkX3c",
      authDomain: "dialog-vip-only-key.firebaseapp.com",
      databaseURL: "https://dialog-vip-only-key-default-rtdb.firebaseio.com",
      projectId: "dialog-vip-only-key",
      storageBucket: "dialog-vip-only-key.firebasestorage.app",
      messagingSenderId: "405714783893",
      appId: "1:405714783893:web:9cf697f2104b91958ed59c",
      measurementId: "G-YKCTBR2857"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, GoogleAuthProvider, signInWithPopup, onAuthStateChanged, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove, off } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});
    const db   = getDatabase(app);

    /* Utils */
    const $  = (q,root=document)=>root.querySelector(q);
    const $$ = (q,root=document)=>Array.from(root.querySelectorAll(q));
    const toastEl = $("#toast"); let toastTimer=null;
    const toast = (t,opts={})=>{
      const {undo} = opts||{};
      toastEl.innerHTML="";
      const span = document.createElement("span");
      span.textContent = t;
      toastEl.appendChild(span);
      if(typeof undo==="function"){
        const b=document.createElement("button");
        b.className="link";
        b.textContent="Undo";
        b.onclick=()=>{ try{ undo(); }finally{ toastEl.style.display="none"; } };
        toastEl.appendChild(b);
      }
      toastEl.style.display="block";
      clearTimeout(toastTimer);
      toastTimer=setTimeout(()=>toastEl.style.display="none", undo?6000:2000);
    };

    /* Elemen */
    const menuBtn=$("#menuBtn"), drawer=$("#drawer"), btnSignOut=$("#btnSignOut");
    const btnSignIn=$("#btnSignIn");
    const globalKey=$("#globalKey"), newKey=$("#newKey"), exp=$("#exp");
    const btnGen=$("#btnGen"), btnAdd=$("#btnAdd"), btnSaveGlobal=$("#btnSaveGlobal"), btnClearGlobal=$("#btnClearGlobal"), btnShareGlobal=$("#btnShareGlobal");
    const reduce=$("#reduce"), sortExpired=$("#sortExpired"), hideGlobal=$("#hideGlobal"), allowSelect=$("#allowSelect");
    const reduce2=$("#reduce2"), sortExpired2=$("#sortExpired2"), hideGlobal2=$("#hideGlobal2"), allowSelect2=$("#allowSelect2");
    const list=$("#list"), list2=$("#list2");
    const chips=$$("#filterChips .chip");
    const bottomLinks=$$("#bottomnav a");

    /* Drawer */
    function openDrawer(){
      drawer.classList.add("open"); drawer.setAttribute("aria-hidden","false"); try{ drawer.inert = false; }catch{}
      menuBtn.setAttribute("aria-expanded","true");
    }
    function closeDrawer(){
      drawer.classList.remove("open");
      drawer.setAttribute("aria-hidden","true"); try{ drawer.inert = true; }catch{}
      menuBtn.setAttribute("aria-expanded","false");
    }
    menuBtn.onclick=openDrawer; $(".backdrop",drawer).onclick=closeDrawer;
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && drawer.classList.contains("open")){ e.preventDefault(); closeDrawer(); }});

    /* Login-only permission: jika sudah login, semua aksi boleh.
       Tidak ada role/whitelist. Offline akan mematikan aksi. */
    const isAuthed = ()=> !!auth.currentUser;
    let IS_OFFLINE = !navigator.onLine;
    const canEdit = ()=> !!auth.currentUser && !IS_OFFLINE;

    /* Routing */
    const protectedRoutes = new Set(["dashboard","keys","settings"]);
    function hardGuard(name){ return protectedRoutes.has(name)&&!isAuthed() ? "login" : name; }
    function updateBottomNav(name){
      $$("#bottomnav a").forEach(a=>{
        const active = a.dataset.route===name;
        a.classList.toggle("active", active);
        a.setAttribute("aria-current", active ? "page" : "false");
      });
    }
    function route(name){
      name = hardGuard(name);
      $$(".page").forEach(p=>p.classList.toggle("show", p.id===`page-${name}`));
      updateBottomNav(name);
      closeDrawer();
      localStorage.setItem("gx:route", name);
    }
    bottomLinks.forEach(a=>a.onclick=()=>route(a.dataset.route));
    chips.forEach(c=>{
      c.onclick=()=>{
        chips.forEach(x=>x.classList.remove("active"));
        c.classList.add("active");
        setFilter(c.dataset.filter);
      };
    });

    /* Filter state */
    function getFilter(){ return localStorage.getItem("gx:filter") || "all"; }
    function setFilter(v){ localStorage.setItem("gx:filter", v); render(); }
    const filter = getFilter(); chips.forEach(c=>c.classList.toggle("active", c.dataset.filter===filter));

    /* Settings (sync sederhana) */
    const SETTINGS_PATH = (uid)=> `auth/users/${uid}/ui`;
    let remoteReady=false, pushing=false;
    const readLocalSettings = ()=> {
      try{ return JSON.parse(localStorage.getItem("gx:ui")||"{}"); }catch{return {}}
    };
    const writeLocalSettings = (data)=>{ try{ localStorage.setItem("gx:ui", JSON.stringify(data||{})); }catch{} };
    function applySettingsToDOM(data){
      reduce.checked=!!data.reduce; sortExpired.checked=!!data.sortExpired; hideGlobal.checked=!!data.hideGlobal; allowSelect.checked=!!data.allowSelect;
      reduce2.checked=!!data.reduce; sortExpired2.checked=!!data.sortExpired; hideGlobal2.checked=!!data.hideGlobal; allowSelect2.checked=!!data.allowSelect;
      render();
    }
    function currentSettings(){
      return {
        reduce: reduce.checked, sortExpired: sortExpired.checked, hideGlobal: hideGlobal.checked, allowSelect: allowSelect.checked,
        statusFilter: getFilter(), updatedAt: Date.now()
      };
    }
    function pushSettings(uid){
      if(!uid) return;
      const data=currentSettings(); pushing=true;
      set(ref(db, SETTINGS_PATH(uid)), data).catch(()=>{}).finally(()=>{pushing=false});
      writeLocalSettings(data);
    }
    function startSettingsSync(uid){
      onValue(ref(db, SETTINGS_PATH(uid)), (s)=>{
        const remote = s.val()||{}; const local=readLocalSettings();
        const rAt=remote.updatedAt||0, lAt=local.updatedAt||0;
        if(pushing){ remoteReady=true; return; }
        if(rAt===0 && lAt>0){ pushSettings(uid); remoteReady=true; return; }
        if(rAt>lAt){ applySettingsToDOM(remote); writeLocalSettings(remote); remoteReady=true; }
        else if(rAt<lAt){ pushSettings(uid); remoteReady=true; }
        else{ applySettingsToDOM(remote||local); remoteReady=true; }
      });
    }

    [reduce,sortExpired,hideGlobal,allowSelect].forEach(el=>{
      el.addEventListener("change", ()=>{
        const data=currentSettings(); applySettingsToDOM(data); writeLocalSettings(data);
        if(isAuthed()) pushSettings(auth.currentUser.uid);
        if(el===sortExpired) render();
      });
    });

    /* Data listeners + offline cache */
    let cache = {}; // { key: {exp:number} }
    let selfWriteAt = 0;
    function startData(){
      stopData();
      onValue(ref(db,"auth/globalKey"), s=>{ globalKey.value = s.exists()? (s.val()||"") : ""; });
      onValue(ref(db,"auth/keys"), s=>{
        const v = s.val()||{};
        const serialized = JSON.stringify(v);
        if(localStorage.getItem("gx:cacheKeys") !== serialized){
          localStorage.setItem("gx:cacheKeys", serialized);
        }
        render(v);
      });
    }
    function stopData(){
      try{ off(ref(db,"auth/globalKey")); off(ref(db,"auth/keys")); }catch{}
    }
    // Offline cache dulu
    try{
      const c = localStorage.getItem("gx:cacheKeys"); if(c){ cache = JSON.parse(c); render(); }
    }catch{}

    /* Auth state */
    onAuthStateChanged(auth, (user)=>{
      if(user){
        updateNav(true);
        render(); // <-- langsung aktifkan tombol sesuai status login (tanpa ganti filter)
        if(!IS_OFFLINE){
          try{ startSettingsSync(user.uid); }catch{}
          try{ startData(); }catch{}
        }
        route(localStorage.getItem("gx:route") || "dashboard");
      }else{
        stopData(); updateNav(false); render(); route("login");
      }
      document.body.classList.remove("booting"); $("#boot")?.remove();
    });

    /* Jaringan: Offline/Online */
    const $offline = document.getElementById('offlineBanner');
    function applyNetworkState(){
      document.body.classList.toggle('offline', IS_OFFLINE);
      if($offline){ $offline.classList.toggle('hide', !IS_OFFLINE); }
      updateNav(isAuthed());
      render(); // <-- re-render supaya state tombol ikut berubah saat jaringan berubah
      if(IS_OFFLINE){
        try{ stopData(); }catch{}
        try{ const uid=auth.currentUser?.uid; if(uid){ off(ref(db, SETTINGS_PATH(uid))); } }catch{}
      }else{
        if(isAuthed()){
          try{ startSettingsSync(auth.currentUser.uid); }catch{}
          try{ startData(); }catch{}
        }
      }
    }
    window.addEventListener('online', ()=>{ IS_OFFLINE=false; applyNetworkState(); toast('Kembali online'); });
    window.addEventListener('offline', ()=>{ IS_OFFLINE=true; applyNetworkState(); toast('Mode offline: fitur dimatikan'); });
    // set awal
    try{ IS_OFFLINE = !navigator.onLine; }catch{}
    applyNetworkState();

    function updateNav(authed){
      document.body.classList.toggle("authed", !!authed);
      document.body.classList.toggle("noauth", !authed);
      btnSignOut.classList.toggle("hide", !authed);
      // Lock aksi hanya bila offline atau belum login
      const editable = !!authed && !IS_OFFLINE;
      btnAdd.disabled = !editable;
      btnGen.disabled = !editable;
      btnSaveGlobal.disabled = !editable;
      btnClearGlobal.disabled = !editable;
      btnShareGlobal.disabled = !editable; // <- simplifikasi: share tetap punya fallback clipboard, jadi cukup ikut editable saja
    }

    /* Login UX */
    btnSignIn?.addEventListener("click", async ()=>{
      try{
        const prov=new GoogleAuthProvider();
        await signInWithPopup(auth, prov);
        toast("Login berhasil");
      }catch{ toast("Login dibatalkan"); }
    });
    btnSignOut?.addEventListener("click", async ()=>{
      try{ await signOut(auth); toast("Keluar"); }catch{}
    });

    /* Render list */
    function render(data){
      if(data){ cache=data; }
      const FILTER = getFilter();
      const arr = Object.entries(cache||{}).map(([k,v])=>({k,exp:Number(v?.exp||0)||0})).sort((a,b)=>a.k.localeCompare(b.k));
      const now = Date.now();

      const expired = arr.filter(x=>x.exp>0 && x.exp<now);
      const active  = arr.filter(x=>x.exp===0 || x.exp>=now);
      const all = sortExpired.checked ? [...active, ...expired] : [...expired, ...active]; // expired di bawah

      const pick = FILTER==="expired" ? expired : FILTER==="active" ? active : all;

      const mkRow = (k, expMs)=>{
        const row=document.createElement("div"); row.className="item";
        if(reduce.checked) row.style.padding="8px 10px";
        const head=document.createElement("div");
        head.textContent=k;
        head.style.fontWeight="700";
        const sub=document.createElement("div");
        sub.className="muted";
        sub.textContent = expMs===0 ? "No Exp" : new Date(expMs).toLocaleDateString();

        const actions=document.createElement("div"); actions.className="row-actions";

        const mk=(label,action)=>{
          const b=document.createElement("button");
          b.className="btn ghost"; b.textContent=label; b.dataset.action=action; return b;
        };
        const btnNoExp=mk("No Exp","noexp");
        const btnDate =mk("Tanggalâ€¦","setdate");
        const btnShare=mk("Share","share");
        const del=mk("Hapus","del"); del.style.background="#2a1212"; del.style.borderColor="#5d2a2a";

        // Saat offline / belum login, tombol baris dimatikan
        if(IS_OFFLINE || !isAuthed()){ btnNoExp.disabled=true; btnDate.disabled=true; del.disabled=true; }

        actions.appendChild(btnNoExp);
        actions.appendChild(btnDate);
        actions.appendChild(btnShare);
        actions.appendChild(del);

        row.appendChild(head); row.appendChild(sub); row.appendChild(actions);
        return row;
      };

      const frag=document.createDocumentFragment();
      pick.forEach(x=> frag.appendChild(mkRow(x.k,x.exp)));
      list.innerHTML=""; list.appendChild(frag);
      list2.innerHTML=""; list2.appendChild(list.cloneNode(true));
    }

    /* Action di list */
    let lastDeleted=null;
    document.addEventListener("click",(e)=>{
      const btn = e.target.closest(".row-actions .btn");
      if(!btn) return;
      const row = btn.closest(".item"); if(!row) return;
      const k = row.querySelector("div").textContent.trim();
      const act = btn.dataset.action;
      (async ()=>{
        try{
          if(act==="share"){
            try{
              await navigator.clipboard.writeText(k);
              toast("Key disalin");
            }catch{ toast("Tidak bisa salin"); }
          } else if(act==="noexp"){
            if(!canEdit()) return;
            selfWriteAt=Date.now();
            await update(ref(db,"auth/keys/"+k), {exp:0});
            toast("No Exp");
          } else if(act==="setdate"){
            if(!canEdit()) return;
            openModalSetDate(k, cache[k]?.exp||0);
          } else if(act==="del"){
            if(!canEdit()) return;
            const ok = await confirmDialog(`Hapus key: ${k}?`);
            if(!ok) return;
            // simpan untuk undo
            lastDeleted = { k, val: cache[k] ? { ...cache[k] } : null };
            selfWriteAt=Date.now();
            await remove(ref(db,"auth/keys/"+k));
            toast(`Dihapus`, {undo: async ()=>{
              if(lastDeleted && lastDeleted.k===k && lastDeleted.val){
                selfWriteAt=Date.now();
                await update(ref(db,"auth/keys/"+k), lastDeleted.val);
                lastDeleted=null;
                toast("Dikembalikan");
              }
            }});
          }
        }catch{ toast("Gagal"); }
      })();
    }, {passive:true});

    /* Form controls */
    btnShareGlobal.onclick = async ()=>{
      const v=(globalKey.value||"").trim();
      try{
        if(navigator.share && v){
          await navigator.share({title:"GxMods Global Key", text:v});
        }else{
          await navigator.clipboard.writeText(v||"");
          toast("Global key disalin");
        }
      }catch{ toast("Tidak bisa share/salin"); }
    };
    btnSaveGlobal.onclick = async ()=>{ if(!canEdit()) return; await set(ref(db,"auth/globalKey"), (globalKey.value||"").trim()); toast("Global key disimpan"); };
    btnClearGlobal.onclick = async ()=>{ if(!canEdit()) return; await set(ref(db,"auth/globalKey"), ""); globalKey.value=""; toast("Dikosongkan"); };

    const toEOD=(Y,M,D)=> new Date(Y, M-1, D, 23, 59, 59, 999).getTime();
    const fromInputDate=(v)=>{ const [Y,M,D]=v.split("-").map(x=>+x); return {Y,M,D}; };

    /* ===== Modal Tanggal ===== */
    const modalDateWrap=$("#modalDateWrap"), modalDate=$("#modalDate"), modalSave=$("#modalSave"), modalCancel=$("#modalCancel");
    let modalKey=null;
    function openModalSetDate(k, expMs){
      modalKey=k;
      modalDateWrap.classList.add("show"); modalDateWrap.setAttribute("aria-hidden","false");
      modalDate.value = expMs>0 ? (new Date(expMs).toISOString().slice(0,10)) : "";
      setTimeout(()=>modalDate.focus(), 30);
    }
    function closeModalDate(){ modalKey=null; modalDateWrap.classList.remove("show"); modalDateWrap.setAttribute("aria-hidden","true"); }
    modalCancel.onclick=closeModalDate;
    modalDateWrap.addEventListener("click",(e)=>{ if(e.target===modalDateWrap) closeModalDate(); });
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && modalDateWrap.classList.contains("show")) closeModalDate(); });
    // Saran #5: Enter = Simpan
    modalDate.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ e.preventDefault(); modalSave.click(); } });
    modalSave.onclick = async ()=>{
      if(!modalKey) return closeModalDate();
      const v=(modalDate.value||"").trim(); if(!v) return closeModalDate();
      const {Y,M,D}=fromInputDate(v); const ms=toEOD(Y,M,D);
      selfWriteAt=Date.now();
      await update(ref(db,"auth/keys/"+modalKey), {exp: ms});
      toast("Tanggal di-set"); closeModalDate();
    };

    /* ===== Modal Konfirmasi ===== */
    const modalConfirmWrap=$("#modalConfirmWrap"), confirmMsg=$("#confirmMsg"), confirmOk=$("#confirmOk"), confirmCancel=$("#confirmCancel");
    function confirmDialog(msg){
      confirmMsg.textContent=msg;
      modalConfirmWrap.classList.add("show"); modalConfirmWrap.setAttribute("aria-hidden","false");
      return new Promise((res)=>{
        const ok=()=>{ cleanup(); res(true); };
        const no=()=>{ cleanup(); res(false); };
        function cleanup(){
          confirmOk.removeEventListener("click", ok);
          confirmCancel.removeEventListener("click", no);
          modalConfirmWrap.classList.remove("show"); modalConfirmWrap.setAttribute("aria-hidden","true");
        }
        confirmOk.addEventListener("click", ok, {once:true});
        confirmCancel.addEventListener("click", no, {once:true});
        modalConfirmWrap.addEventListener("click",(e)=>{ if(e.target===modalConfirmWrap) no(); }, {once:true});
      });
    }

    /* Tambah key baru */
    btnGen.onclick = ()=>{
      const CH="ABCDEFGHJKLMNPQRSTUVWXYZ23456789";
      const seg=(n)=> Array.from({length:n},()=>CH[Math.floor(Math.random()*CH.length)]).join("");
      const v=`VIP-${seg(4)}-${seg(4)}`;
      newKey.value=v; newKey.focus();
    };
    btnAdd.onclick = async ()=>{
      if(!canEdit()) return;
      const k=(newKey.value||"").trim(); if(!k) return newKey.focus();
      const val=(exp.value||"").trim();
      let ms=0; if(val){ const {Y,M,D}=fromInputDate(val); ms=toEOD(Y,M,D); }
      selfWriteAt=Date.now();
      await update(ref(db,"auth/keys/"+k), {exp: ms});
      newKey.value=""; exp.value=""; toast("Ditambahkan");
    };
  </script>
</body>
</html>
