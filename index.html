<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#0b0f14" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>GxMods Key Panel</title>
  <style>
    *,*::before,*::after{box-sizing:border-box}
    html,body{height:100%}
    :root{
      --bg:#0b0f14;--card:#0f1622;--line:#1a2331;--muted:#9fb1c3;
      --pri:#7c3aed;--ok:#19c37d;--r:16px; --shadow:0 6px 24px rgba(0,0,0,.28);
      --bn-h:60px;
    }
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
      background:var(--bg);color:#e6edf3;-webkit-tap-highlight-color:transparent;
      touch-action:manipulation;
      user-select:none; -webkit-user-select:none; -ms-user-select:none; -webkit-touch-callout:none;
    }
    body.allow-select{user-select:text; -webkit-user-select:text; -webkit-touch-callout:auto}
    a{color:inherit;text-decoration:none}
    img,svg{display:block;max-width:100%}
    .hide{display:none !important}

    input,textarea{user-select:text; -webkit-user-select:text}

    body,button,input,select,textarea{color:#e6edf3}
    .btn{color:#e6edf3}
    input:not([type="checkbox"]):not([type="radio"]):not([type="range"]):not([type="file"]),
    select, textarea{
      width:100%;padding:14px;border-radius:12px;background:#0a0a0a;border:1px solid #30363d;outline:none;
      appearance:none;-webkit-appearance:none;-moz-appearance:none;font-size:16px;
    }
    input::placeholder, textarea::placeholder{color:#9aa7b3}
    input:-webkit-autofill{ -webkit-text-fill-color:#fff; box-shadow:0 0 0 1000px #0a0a0a inset; border:1px solid #30363d; caret-color:#fff; }

    /* Topbar */
    .topbar{position:sticky;top:0;z-index:40;height:56px;display:flex;align-items:center;gap:12px;padding:0 14px;background:#0c111b;border-bottom:1px solid var(--line)}
    .title{font-weight:700}
    .grow{flex:1}
    .btn{display:inline-flex;align-items:center;gap:8px;padding:10px 12px;border-radius:14px;border:1px solid var(--line);background:#0f1622;box-shadow:var(--shadow);cursor:pointer}
    .btn.ghost{background:transparent}
    .btn.small{padding:8px 10px;border-radius:10px}
    .btn:active{transform:translateY(1px)}
    .btn[disabled]{opacity:.6;pointer-events:none}
    .icon{width:20px;height:20px}

    /* Drawer */
    .drawer{position:fixed;inset:0 auto 0 0;width:min(78%,320px);background:#0e1420;border-right:1px solid var(--line);transform:translateX(-100%);transition:transform .16s ease-out;z-index:50;contain:paint}
    .drawer.open{transform:translateX(0)}
    .drawer .brand{display:flex;align-items:center;gap:10px;padding:14px;border-bottom:1px solid var(--line)}
    .nav{padding:8px}
    .nav a{display:flex;align-items:center;gap:12px;padding:12px 14px;border-radius:12px;border:1px solid transparent}
    .nav a:hover{background:#0f1622}
    .nav a.active{border-color:#213048;background:#0f1622}
    .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.45);opacity:0;pointer-events:none;transition:opacity .16s ease;z-index:45}
    .backdrop.show{opacity:1;pointer-events:auto}

    /* App (padding bawah untuk bottom nav) */
    .app{min-height:calc(100dvh - 56px);padding:14px 14px calc(14px + var(--bn-h) + env(safe-area-inset-bottom));display:flex;flex-direction:column;gap:14px}
    body.noauth .app{padding-bottom:14px}
    .page{display:none}
    .page.show{display:grid;gap:16px}
    .card{background:var(--card);border:1px solid var(--line);border-radius:var(--r);box-shadow:var(--shadow);padding:14px;display:flex;flex-direction:column;gap:12px}
    .muted{color:var(--muted);font-size:.95rem}
    .grid{display:grid;gap:12px;grid-template-columns:repeat(2,minmax(0,1fr))}
    @media (max-width:560px){.grid{grid-template-columns:1fr}}

    .list{display:flex;flex-direction:column;border:1px solid var(--line);border-radius:14px;overflow:hidden}
    .item{padding:12px;background:#0e1420;border-bottom:1px solid var(--line)}
    .item:nth-child(2n){background:#0d131e}
    .item:last-child{border-bottom:none}
    .row1{display:flex;align-items:center;gap:10px}
    .row1 .grow{flex:1;min-width:0}
    .row1 strong{word-break:break-all}
    .row2{margin-top:4px}
    .row3{margin-top:10px;display:flex;gap:6px;flex-wrap:wrap;justify-content:flex-end}
    @media (max-width:720px){ .row3{justify-content:flex-start} }

    .pill{padding:3px 8px;border-radius:999px;border:1px solid var(--line);font-size:.8rem;white-space:nowrap}
    .ok{background:#10221a;border-color:#1f4e39;color:#9de7c4}
    .exp{background:#2a1414;border-color:#5d2a2a;color:#ffc8c8}

    .chip{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border:1px solid var(--line);border-radius:999px;background:#0f1622;cursor:pointer;user-select:none}

    .switch{display:inline-flex;align-items:center;gap:10px}
    .switch input{position:absolute;opacity:0;width:0;height:0}
    .switch .track{width:44px;height:26px;background:#1f2937;border:1px solid var(--line);border-radius:999px;position:relative;transition:background .15s,border-color .15s}
    .switch .thumb{position:absolute;top:2px;left:2px;width:22px;height:22px;border-radius:50%;background:#cbd5e1;transition:left .15s,background .15s}
    .switch input:checked + .track{background:#12211a;border-color:#1f4e39}
    .switch input:checked + .track .thumb{left:20px;background:#9de7c4}

    /* Guard states */
    body.noauth .guarded{display:none !important}
    body.authed .login-only{display:none !important}
    body.noauth #menuBtn, body.noauth #btnSignOut{display:none !important}
    body.noauth .topbar, body.noauth #drawer, body.noauth #backdrop, body.noauth #bottomnav{display:none !important}

    /* Booting splash */
    body.booting .page{display:none !important}
    #boot{position:fixed; inset:0; display:grid; place-items:center; background:var(--bg); z-index:100; font-size:14px; color:var(--muted)}

    .lite .btn,.lite .card{box-shadow:none}
    .reduce *{transition:none!important;animation:none!important}

    /* Login page centered */
    [data-page="login"].show{min-height:calc(100dvh - 56px); place-content:center}

    /* Centered Toast */
    #toast{
      position:fixed; left:50%; top:50%; transform:translate(-50%,-50%);
      background:#111827;border:1px solid #263248;padding:12px 16px;border-radius:12px;box-shadow:var(--shadow);
      display:none; z-index:99; pointer-events:none; text-align:center; max-width:min(92vw,520px)
    }

    .dense .item{padding:8px}
    .dense .pill{font-size:.74rem;padding:2px 6px}
    .dense .btn.small{padding:6px 8px}

    /* Bottom Navigation */
    .bottomnav{
      position:fixed; left:0; right:0; bottom:0; height:var(--bn-h);
      background:#0c111b; border-top:1px solid var(--line);
      display:grid; grid-template-columns:repeat(2,1fr); z-index:41; padding-bottom:env(safe-area-inset-bottom);
    }
    .bottomnav a{
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      gap:4px; font-size:.85rem; color:var(--muted);
    }
    .bottomnav a .bi{width:22px;height:22px}
    .bottomnav a.active{color:#fff}
  </style>
</head>
<body class="noauth booting">
  <!-- Topbar -->
  <header class="topbar">
    <button id="menuBtn" class="btn" aria-label="Menu" aria-haspopup="true" aria-controls="drawer" aria-expanded="false">
      <svg class="icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.8" stroke-linecap="round"><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="18" x2="21" y2="18"/></svg>
      <span>Menu</span>
    </button>
    <div class="title">GxMods Key Panel</div>
    <div class="grow"></div>
    <button id="btnSignOut" class="btn ghost">Sign Out</button>
  </header>

  <!-- Drawer (tabindex -1 + inert saat tertutup) -->
  <aside id="drawer" class="drawer" aria-hidden="true" tabindex="-1">
    <div class="brand"><strong>Menu</strong></div>
    <nav class="nav" id="nav">
      <!-- Dashboard dihapus (sudah ada Home di bottom nav) -->
      <!-- Daftar Key juga sudah di bottom nav -->
      <a href="#settings" data-route="settings" data-auth="in">Pengaturan</a>
      <a href="#about" data-route="about">Tentang</a>
    </nav>
  </aside>
  <div id="backdrop" class="backdrop"></div>

  <!-- App -->
  <main id="app" class="app">
    <!-- Dashboard -->
    <section class="page guarded" data-page="dashboard">
      <div class="grid">
        <div class="card">
          <h3>Status</h3>
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <span class="muted">Key aktif</span><strong id="kpiKeys">0</strong>
          </div>
          <div class="row" style="display:flex;justify-content:space-between;align-items:center">
            <span class="muted">Key expired</span><strong id="kpiExp">0</strong>
          </div>
        </div>
      </div>
    </section>

    <!-- Keys -->
    <section class="page guarded" data-page="keys">
      <div class="card" id="globalKeyCard">
        <h3 style="text-align:center">Buat Key</h3>
        <div class="row" style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
          <input id="newKey" type="text" placeholder="Key (atau klik Generate)" style="flex:1;min-width:180px"/>
          <button id="btnGen" class="btn small" style="margin-left:auto">Generate</button>
        </div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap;align-items:center">
          <label class="muted" for="exp" style="min-width:160px">Tanggal kadaluarsa (opsional)</label>
          <input id="exp" type="date" inputmode="none" placeholder="yyyy-mm-dd" style="max-width:220px"/>
          <span class="chip" data-add="7">+7 hari</span>
          <span class="chip" data-add="0">Tanpa Exp</span>
          <div style="flex:1"></div>
          <button id="btnAdd" class="btn small">Tambah</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="display:flex;justify-content:space-between;gap:8px;align-items:center;flex-wrap:wrap">
          <h3 style="margin:0">Daftar Key</h3>
          <input id="search" type="search" placeholder="Cari key…" style="min-width:160px;max-width:260px">
        </div>
        <div id="keyList" class="list" role="list"></div>
      </div>
    </section>

    <!-- Settings -->
    <section class="page guarded" data-page="settings">
      <div class="card">
        <h3>Pengaturan</h3>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Padatkan daftar key</strong>
            <div class="muted">Tinggi item & button jadi lebih ringkas.</div>
          </div>
          <label class="switch">
            <input id="dense" type="checkbox">
            <span class="track"><i class="thumb"></i></span>
          </label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Kurangi animasi</strong>
            <div class="muted">Matikan transisi & bayangan.</div>
          </div>
        <label class="switch">
            <input id="reduce" type="checkbox">
            <span class="track"><i class="thumb"></i></span>
          </label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Urutkan expired dulu</strong>
            <div class="muted">Prioritaskan yang kadaluarsa di atas.</div>
          </div>
          <label class="switch">
            <input id="sortExpired" type="checkbox">
            <span class="track"><i class="thumb"></i></span>
          </label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Sembunyikan Global Key</strong>
            <div class="muted">Sembunyikan kartu Global Key bila tak dipakai.</div>
          </div>
          <label class="switch">
            <input id="hideGlobal" type="checkbox">
            <span class="track"><i class="thumb"></i></span>
          </label>
        </div>

        <div class="row" style="display:flex;justify-content:space-between;align-items:center;gap:8px">
          <div>
            <strong>Izinkan seleksi teks</strong>
            <div class="muted">Matikan anti-salin bila perlu.</div>
          </div>
          <label class="switch">
            <input id="allowSelect" type="checkbox">
            <span class="track"><i class="thumb"></i></span>
          </label>
        </div>

      </div>
    </section>

    <!-- About -->
    <section class="page" data-page="about">
      <div class="card">
        <h3>Tentang Panel</h3>
        <p class="muted">Panel ini buat kelola Global Key & daftar key dengan fokus ke performa ringan (RAM 2GB oke), UI gelap, dan aksi cepat (copy, tambah masa aktif, set tanggal, hapus). Menu Pengaturan berisi opsi yang berdampak visual & perilaku — disinkronkan lintas perangkat.</p>
      </div>
    </section>

    <!-- Login -->
    <section class="page login-only" data-page="login">
      <div class="card" style="max-width:480px; margin-inline:auto">
        <h3>Login Admin</h3>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <input id="email" type="email" placeholder="Email" autocomplete="username">
        </div>
        <div class="row" style="display:flex;gap:8px;flex-wrap:wrap">
          <div style="position:relative;width:100%">
            <input id="password" type="password" placeholder="Password" autocomplete="current-password">
            <button id="togglePass" class="btn small" style="position:absolute;right:6px;top:6px">Lihat</button>
          </div>
        </div>
        <div class="row" style="display:flex;justify-content:center">
          <button id="btnLogin" class="btn">Sign In</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bottom Navigation -->
  <nav id="bottomnav" class="bottomnav" role="navigation" aria-label="Navigasi utama">
    <a href="#dashboard" data-route="dashboard" id="bn-home" aria-current="page">
      <svg class="bi" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><path d="M3 9.5 12 3l9 6.5"/><path d="M5 10v10h14V10"/></svg>
      <span>Home</span>
    </a>
    <a href="#keys" data-route="keys" id="bn-keys">
      <svg class="bi" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.6" stroke-linecap="round" stroke-linejoin="round"><circle cx="7" cy="8" r="3"/><path d="M10 8h10l-2 2 2 2-2 2 2 2"/></svg>
      <span>Daftar Key</span>
    </a>
  </nav>

  <!-- Splash boot -->
  <div id="boot"><span class="muted">Memuat…</span></div>

  <!-- Toast -->
  <div id="toast"></div>

  <script type="module">
    /* Firebase (tanpa proteksi ekstra) */
    const ADMIN_UID = "4CCiNyEyTvSUPnY6Ugd9PzAU1df2";
    const firebaseConfig = {
      apiKey: "AIzaSyAJ2YitGgxTI8k440TmWUHgntkTLSqkX3c",
      authDomain: "dialog-vip-only-key.firebaseapp.com",
      databaseURL: "https://dialog-vip-only-key-default-rtdb.firebaseio.com",
      projectId: "dialog-vip-only-key",
      storageBucket: "dialog-vip-only-key.firebasestorage.app",
      messagingSenderId: "405714783893",
      appId: "1:405714783893:web:9cf697f2104b91958ed59c",
      measurementId: "G-YKCTBR2857"
    };

    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
    import {
      getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut,
      setPersistence, browserLocalPersistence
    } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
    import { getDatabase, ref, onValue, set, update, remove, off } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-database.js";

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    setPersistence(auth, browserLocalPersistence).catch(()=>{});
    const db   = getDatabase(app);

    /* Utils */
    const $ = (s,el=document)=>el.querySelector(s);
    const $$ = (s,el=document)=>el.querySelectorAll(s);
    const toast = (t)=>{ const el=$("#toast"); el.textContent=t; el.style.display="block"; clearTimeout(window._t); window._t=setTimeout(()=>el.style.display="none",2000); }

    const protectedRoutes = new Set(["dashboard","keys","settings"]);

    /* Drawer control + a11y */
    const menuBtn = $("#menuBtn");
    const drawer  = $("#drawer");
    const backdrop= $("#backdrop");
    drawer.setAttribute("aria-hidden","true");
    try{ drawer.inert = true; }catch{}

    function openDrawer(){
      drawer.classList.add("open");
      backdrop.classList.add("show");
      drawer.removeAttribute("aria-hidden");
      try{ drawer.inert = false; }catch{}
      menuBtn.setAttribute("aria-expanded","true");
      const first = drawer.querySelector(".nav a") || drawer;
      (first instanceof HTMLElement ? first : drawer).focus();
    }

    function closeDrawer(){
      if (drawer.contains(document.activeElement)) { menuBtn.focus(); }
      drawer.classList.remove("open");
      backdrop.classList.remove("show");
      drawer.setAttribute("aria-hidden","true");
      try{ drawer.inert = true; }catch{}
      menuBtn.setAttribute("aria-expanded","false");
    }

    menuBtn.onclick = openDrawer;
    backdrop.onclick = closeDrawer;
    document.addEventListener("keydown",(e)=>{ if(e.key==="Escape" && drawer.classList.contains("open")){ e.preventDefault(); closeDrawer(); }});

    /* Routing */
    const isAuthed = ()=> auth.currentUser && auth.currentUser.uid===ADMIN_UID;

    function hardGuard(name){
      if(protectedRoutes.has(name) && !isAuthed()) return "login";
      return name;
    }

    function updateBottomNav(name){
      $$("#bottomnav a").forEach(a=>{
        const active = a.dataset.route===name;
        a.classList.toggle("active", active);
        a.setAttribute("aria-current", active ? "page" : "false");
      });
    }

    function route(name){
      name = hardGuard(name);
      $$(".page").forEach(p=>p.classList.toggle("show",p.dataset.page===name));
      $$(".nav a").forEach(a=>a.classList.toggle("active",a.dataset.route===name));
      updateBottomNav(name);
      if(isAuthed()){ localStorage.setItem("gx:route", name); } else { localStorage.removeItem("gx:route"); }
      closeDrawer();
      try{ document.scrollingElement.scrollTo({top:0,behavior:"smooth"}); }catch{}
    }

    // Drawer nav
    $$(".nav a").forEach(a=>a.onclick=(e)=>{e.preventDefault(); route(a.dataset.route);});
    // Bottom nav
    $$("#bottomnav a").forEach(a=>a.addEventListener("click",(e)=>{ e.preventDefault(); route(a.dataset.route); }, {passive:false}));

    /* UI refs */
    const globalKey=$("#globalKey"), btnSaveGlobal=$("#btnSaveGlobal"), btnClearGlobal=$("#btnClearGlobal");
    const newKey=$("#newKey"), btnGen=$("#btnGen"), exp=$("#exp"), btnAdd=$("#btnAdd");
    const keyList=$("#keyList"), search=$("#search");
    const kpiKeys=$("#kpiKeys"), kpiExp=$("#kpiExp");
    const dense=$("#dense"), reduce=$("#reduce"), sortExpired=$("#sortExpired"), hideGlobal=$("#hideGlobal"), allowSelect=$("#allowSelect");
    const email=$("#email"), password=$("#password"), btnLogin=$("#btnLogin");
    const btnSignOut=$("#btnSignOut");
    const togglePass=$("#togglePass");
    const globalKeyCard=$("#globalKeyCard");

    /* ===== Pengaturan: Local + Remote Sync (Firebase) ===== */
    const SETTINGS_PATH = (uid)=>`auth/settings/${uid}`;

    function readLocalSettings(){
      return {
        dense: localStorage.getItem("gx:dense")==="1",
        reduce: localStorage.getItem("gx:reduce")==="1",
        sortExpired: localStorage.getItem("gx:sortExp")==="1",
        hideGlobal: localStorage.getItem("gx:hideGlobal")==="1",
        allowSelect: localStorage.getItem("gx:allowSelect")==="1",
        updatedAt: parseInt(localStorage.getItem("gx:settingsUpdatedAt")||"0",10)||0
      };
    }

    function writeLocalSettings(obj){
      localStorage.setItem("gx:dense", obj.dense?"1":"0");
      localStorage.setItem("gx:reduce", obj.reduce?"1":"0");
      localStorage.setItem("gx:sortExp", obj.sortExpired?"1":"0");
      localStorage.setItem("gx:hideGlobal", obj.hideGlobal?"1":"0");
      localStorage.setItem("gx:allowSelect", obj.allowSelect?"1":"0");
      localStorage.setItem("gx:settingsUpdatedAt", String(obj.updatedAt||Date.now()));
    }

    function applySettingsToDOM(obj){
      dense.checked = !!obj.dense;
      reduce.checked = !!obj.reduce;
      sortExpired.checked = !!obj.sortExpired;
      hideGlobal.checked = !!obj.hideGlobal;
      allowSelect.checked = !!obj.allowSelect;

      document.body.classList.toggle('dense', dense.checked);
      document.body.classList.toggle('reduce', reduce.checked);
      document.body.classList.toggle('allow-select', allowSelect.checked);
      globalKeyCard.classList.toggle('hide', hideGlobal.checked);
      document.documentElement.style.scrollBehavior = reduce.checked?"auto":"smooth";
    }

    // init dari local
    applySettingsToDOM(readLocalSettings());

    let pushing = false;
    let remoteReady = false;

    function buildCurrentSettings(){
      return {
        dense: dense.checked,
        reduce: reduce.checked,
        sortExpired: sortExpired.checked,
        hideGlobal: hideGlobal.checked,
        allowSelect: allowSelect.checked,
        updatedAt: Date.now()
      };
    }

    function pushSettings(uid){
      if(!uid) return;
      const data = buildCurrentSettings();
      pushing = true;
      set(ref(db, SETTINGS_PATH(uid)), data)
        .catch(()=>{})
        .finally(()=>{ pushing = false; });
      writeLocalSettings(data);
    }

    function startSettingsSync(uid){
      const path = ref(db, SETTINGS_PATH(uid));
      onValue(path, (s)=>{
        const remote = s.val()||{};
        const local = readLocalSettings();
        const rAt = remote.updatedAt||0;
        const lAt = local.updatedAt||0;

        // hindari loop saat kita yang baru saja push
        if(pushing){ remoteReady = true; return; }

        if(rAt===0 && lAt>0){
          // Tidak ada remote, dorong yang lokal
          pushSettings(uid);
          remoteReady = true;
          return;
        }

        if(rAt > lAt){
          // Remote lebih baru → pakai remote
          writeLocalSettings(remote);
          applySettingsToDOM(remote);
        } else if (rAt < lAt && remoteReady){
          // Lokal lebih baru (dan remote sudah pernah terisi) → dorong lokal
          pushSettings(uid);
        }

        remoteReady = true;
      });
    }

    // Toggle handlers: update DOM, local, dan remote (debounce)
    let syncTimer=null;
    function scheduleSync(uid){
      clearTimeout(syncTimer);
      syncTimer = setTimeout(()=>pushSettings(uid), 250);
    }

    [dense,reduce,sortExpired,hideGlobal,allowSelect].forEach(el=>{
      el.addEventListener("change", ()=>{
        const obj = buildCurrentSettings();
        applySettingsToDOM(obj);
        writeLocalSettings(obj);
        if(isAuthed()) scheduleSync(auth.currentUser.uid);
        if(el===sortExpired) render();
      });
    });

    /* Data listeners */
    const listeners = [];
    function startData(){
      stopData();
      listeners.push(onValue(ref(db,"auth/globalKey"), s=>{ globalKey.value = s.exists()? (s.val()||"") : ""; }));
      listeners.push(onValue(ref(db,"auth/keys"), s=>{ cache = s.val()||{}; render(); }));
    }
    function stopData(){
      try{ off(ref(db,"auth/globalKey")); off(ref(db,"auth/keys")); }catch{}
      listeners.length=0;
    }

    /* Auth state */
    onAuthStateChanged(auth, (user)=>{
      if(user && user.uid===ADMIN_UID){
        startSettingsSync(user.uid); // mulai sync settings begitu login
        updateNav(true);
        startData();
        route(localStorage.getItem("gx:route") || "dashboard");
      }else{
        stopData();
        updateNav(false);
        route("login");
        if(user && user.uid!==ADMIN_UID){ signOut(auth).catch(()=>{}); toast("Bukan admin"); }
      }
      // Lepas splash setelah halaman dipilih → tanpa kedip login
      document.body.classList.remove("booting");
      document.getElementById("boot")?.remove();
    });

    function updateNav(authed){
      document.body.classList.toggle("authed", !!authed);
      document.body.classList.toggle("noauth", !authed);
      $("#btnSignOut").classList.toggle("hide", !authed);
    }

    /* Login UX */
    $("#togglePass").addEventListener("click", ()=>{
      const pw = $("#password");
      const type = pw.getAttribute("type")==="password" ? "text" : "password";
      pw.setAttribute("type", type);
      $("#togglePass").textContent = (type==="password"?"Lihat":"Sembunyikan");
      pw.focus();
    });

    document.addEventListener("keydown", (e)=>{
      if(e.key==="Enter" && $(".page.show")?.dataset.page==="login"){ $("#btnLogin").click(); }
    });

    $("#btnLogin").addEventListener("click", async ()=>{
      const em=($("#email").value||"").trim();
      const pw=$("#password").value||"";
      if(!em || !pw){ toast("Isi email & password"); return; }
      try{
        $("#btnLogin").disabled = true; $("#btnLogin").textContent = "Masuk…";
        await signInWithEmailAndPassword(auth, em, pw);
        toast("Login sukses");
      }catch{
        toast("Login gagal");
      }finally{
        $("#btnLogin").disabled = false; $("#btnLogin").textContent = "Sign In";
      }
    });

    $("#btnSignOut").onclick = async ()=>{
      try{
        $("#btnSignOut").disabled = true;
        await signOut(auth);
        toast("Signed out");
        route("login");
      }catch{}finally{ $("#btnSignOut").disabled = false; }
    };

    /* Anti tahan/salin di luar input */
    const allowCtx = (el)=> !!el && (el.closest('input,textarea,[contenteditable="true"]'));
    document.addEventListener('copy',  e=>{ if(!document.body.classList.contains('allow-select') && !allowCtx(document.activeElement)) e.preventDefault(); });
    document.addEventListener('cut',   e=>{ if(!document.body.classList.contains('allow-select') && !allowCtx(document.activeElement)) e.preventDefault(); });
    document.addEventListener('contextmenu', e=>{ if(!document.body.classList.contains('allow-select') && !allowCtx(e.target)) e.preventDefault(); }, {passive:false});

    /* Render keys */
    let cache = {};

    function render(){
      const ks = Object.keys(cache||{});
      let expCount=0;
      const now=Date.now();
      for(const k of ks){ const v=cache[k]?.exp||0; if(v && now>v) expCount++; }
      kpiKeys.textContent = String(ks.length);
      kpiExp.textContent  = String(expCount);

      keyList.innerHTML="";
      const q = (search?.value||"").trim().toUpperCase();
      const frag = document.createDocumentFragment();

      ks.sort((a,b)=>{
        if(sortExpired.checked){
          const ea = (cache[a]?.exp||0) && now>(cache[a].exp);
          const eb = (cache[b]?.exp||0) && now>(cache[b].exp);
          if(ea!==eb) return eb - ea; // expired duluan
        }
        return a.localeCompare(b);
      });

      for(const k of ks){
        if(q && !k.toUpperCase().includes(q)) continue;
        const expMs=cache[k]?.exp||0;
        const expired = expMs && now>expMs;

        const row = document.createElement("div");
        row.className="item";

        // Baris atas: key + status pill kanan
        const head = document.createElement("div");
        head.className="row1";
        const keySpan = document.createElement("strong");
        keySpan.className="grow";
        keySpan.textContent = k;
        const status = document.createElement("span");
        status.className="pill "+(expired?"exp":"ok");
        status.textContent = expired?"Expired":"Aktif";
        head.appendChild(keySpan);
        head.appendChild(status);

        // Baris tanggal kecil
        const sub = document.createElement("div");
        sub.className="row2 muted";
        const expStr = expMs? new Date(expMs).toLocaleDateString("id-ID",{day:"2-digit",month:"short",year:"numeric"}) : "Permanen";
        sub.textContent = "Expire: "+expStr;

        // Aksi
        const actions = document.createElement("div");
        actions.className="row3";
        const mk=(txt,action)=>{ const b=document.createElement("button"); b.className="btn small"; b.textContent=txt; b.dataset.key=k; b.dataset.action=action; return b; };
        actions.appendChild(mk("Copy","copy"));
        actions.appendChild(mk("+7","add7"));
        actions.appendChild(mk("No Exp","noexp"));
        actions.appendChild(mk("Tanggal…","setdate"));
        const del=mk("Hapus","del"); del.style.background="#2a1212"; del.style.borderColor="#5d2a2a"; actions.appendChild(del);

        row.appendChild(head);
        row.appendChild(sub);
        row.appendChild(actions);
        frag.appendChild(row);
      }
      if(!frag.childNodes.length){
        const empty=document.createElement("div"); empty.className="item"; empty.innerHTML='<span class="muted">Belum ada data.</span>'; frag.appendChild(empty);
      }
      keyList.appendChild(frag);
    }

    /* Key actions */
    document.addEventListener("click",(e)=>{
      const b=e.target.closest("button[data-action]"); if(!b) return;
      const k=b.dataset.key, act=b.dataset.action;
      (async()=>{
        try{
          if(act==="copy"){ await navigator.clipboard.writeText(k); toast("Disalin"); }
          else if(act==="add7"){
            const cur=cache[k]?.exp||0;
            const base=Math.max(cur||0, Date.now());
            await update(ref(db,"auth/keys/"+k), {exp: base + 7*864e5});
            toast("+7 hari");
          }
          else if(act==="noexp"){ await update(ref(db,"auth/keys/"+k), {exp:0}); toast("No Exp"); }
          else if(act==="setdate"){
            const cur=cache[k]?.exp||0;
            const seed = cur? new Date(cur): new Date();
            const pad=n=>String(n).padStart(2,"0");
            const def=`${seed.getFullYear()}-${pad(seed.getMonth()+1)}-${pad(seed.getDate())}`;
            const v=prompt("YYYY-MM-DD (kosong = No Exp)", def);
            if(v===null) return;
            const ms = v.trim()===""?0:(()=>{ const [Y,M,D]=v.split("-").map(n=>parseInt(n,10)); return new Date(Y,M-1,D,23,59,59,999).getTime(); })();
            await update(ref(db,"auth/keys/"+k), {exp: ms});
            toast("Tanggal di-set");
          }
          else if(act==="del"){ if(confirm(`Hapus key:\n${k}?`)){ await remove(ref(db,"auth/keys/"+k)); toast("Dihapus"); } }
        }catch{ toast("Gagal"); }
      })();
    }, {passive:true});

    /* Form controls */
    $("#btnGen").onclick = ()=>{
      const rand = ()=>Math.random().toString(36).slice(2,6).toUpperCase();
      $("#newKey").value = `${rand()}-${rand()}-${rand()}-${rand()}`;
      $("#newKey").focus();
    };
    $("#btnAdd").onclick = async ()=>{
      const k=($("#newKey").value||"").trim(); if(!k) return toast("Isi key");
      const val = ($("#exp").value||"").trim();
      let ms=0; if(val){ const [Y,M,D]=val.split("-").map(n=>parseInt(n,10)); ms=new Date(Y,M-1,D,23,59,59,999).getTime(); }
      await update(ref(db,"auth/keys/"+k), {exp: ms});
      $("#newKey").value=""; $("#exp").value="";
      toast("Ditambahkan");
    };
    $("#btnSaveGlobal").onclick = async ()=>{ await set(ref(db,"auth/globalKey"), ($("#globalKey").value||"").trim()); toast("Global key disimpan"); };
    $("#btnClearGlobal").onclick = async ()=>{ await set(ref(db,"auth/globalKey"), ""); $("#globalKey").value=""; toast("Dikosongkan"); };

    $("#search")?.addEventListener("input", ()=>render(), {passive:true});
  </script>
</body>
</html>
